# å¤šæ–‡ä»¶ä¸Šä¼ ä¸ä¸€è‡´æ€§åˆ†æåŠŸèƒ½ - ä¿®å¤å®Œæˆ

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. å¤šæ–‡ä»¶ä¸Šä¼ åæ²¡æœ‰ååº”
**é—®é¢˜**ï¼šä¸Šä¼ å®Œæˆååœç•™åœ¨ä¸Šä¼ ç•Œé¢
**åŸå› **ï¼šå‰ç«¯åˆ¤æ–­é€»è¾‘åªæ£€æŸ¥ `fileData`ï¼Œå¤šæ–‡ä»¶æ¨¡å¼éœ€è¦æ£€æŸ¥ `fileGroup`
**ä¿®å¤æ–‡ä»¶**ï¼š
- `frontend/src/components/WorkArea/WorkArea.jsx`
- `frontend/src/components/Layout/MainLayout.jsx`

### 2. ä¸Šä¼ æ–‡ä»¶å¸ƒå±€é—®é¢˜
**é—®é¢˜**ï¼šæ ‡ç­¾æ˜¾ç¤ºä¸åˆç†ï¼Œæç¤ºä¿¡æ¯ä¸æ¸…æ™°
**ä¿®å¤æ–‡ä»¶**ï¼š
- `frontend/src/components/FileUpload/FileUpload.jsx`
- `frontend/src/components/FileUpload/FileUpload.css`

### 3. å¤šæ–‡ä»¶åˆ†ææ—¶åç«¯æŠ¥é”™
**é—®é¢˜**ï¼š`KeyError: 'file_id'` - å¤šæ–‡ä»¶æ¨¡å¼çš„sessionç»“æ„ä¸åŒ
**åŸå› **ï¼šå¤šæ–‡ä»¶sessionæœ‰ `group_id` å’Œ `tables`ï¼Œè€Œé `file_id`
**ä¿®å¤æ–‡ä»¶**ï¼š
- `backend/api/agent.py` - æ·»åŠ äº†å•æ–‡ä»¶/å¤šæ–‡ä»¶æ¨¡å¼åˆ¤æ–­
- `backend/core/agent.py` - æ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„promptæ„å»ºæ–¹å¼

**ä¿®å¤ä»£ç **ï¼š
```python
# backend/api/agent.py
is_multi = session_info.get('is_multi', False)

if is_multi:
    # å¤šæ–‡ä»¶æ¨¡å¼ï¼šä»ç¼“å­˜æ„å»ºå¤šè¡¨æ ¼ data_schema
    tables_info = []
    for table in session_info.get('tables', []):
        file_info = file_cache.get(table['file_id'])
        # æå–æ¯ä¸ªè¡¨æ ¼çš„ä¿¡æ¯
    data_schema = {
        'is_multi': True,
        'tables': tables_info
    }
else:
    # å•æ–‡ä»¶æ¨¡å¼ï¼šåŸæœ‰é€»è¾‘
    file_info = file_cache.get(session_info['file_id'])
    # ...
```

---

## ğŸ‰ å½“å‰åŠŸèƒ½çŠ¶æ€

### âœ… å®Œå…¨å¯ç”¨çš„åŠŸèƒ½

1. **å•æ–‡ä»¶æ¨¡å¼**ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
   - ä¸Šä¼ å•ä¸ªæ–‡ä»¶
   - é€‰æ‹©å·¥ä½œè¡¨å’Œå­—æ®µ
   - AI åˆ†æ

2. **å¤šæ–‡ä»¶æ¨¡å¼**ï¼ˆæ–°åŠŸèƒ½ï¼‰
   - ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼ˆæœ€å¤š10ä¸ªï¼‰
   - è‡ªåŠ¨è·³è½¬åˆ°é¢„è§ˆç•Œé¢
   - å‹¾é€‰è¦åˆ†æçš„è¡¨æ ¼
   - è‡ªåŠ¨åˆ†é…å˜é‡åï¼ˆdf1, df2, df3...ï¼‰
   - AI ç”Ÿæˆè·¨è¡¨æ ¼ä¸€è‡´æ€§åˆ†æä»£ç 
   - æ‰§è¡Œåˆ†æå¹¶æ˜¾ç¤ºç»“æœ

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åç«¯**
```bash
cd backend
python main.py
```

2. **å¯åŠ¨å‰ç«¯**
```bash
cd frontend  
npm run dev
```

3. **æµ‹è¯•å¤šæ–‡ä»¶åˆ†æ**
   - åˆ‡æ¢åˆ°"å¤šæ–‡ä»¶å¯¹æ¯”"æ¨¡å¼
   - ä¸Šä¼ 2ä¸ªæ–‡ä»¶ï¼š`BI-27.xlsx` å’Œ `å•†æˆ·27.xlsx`
   - âœ… è‡ªåŠ¨æ˜¾ç¤ºå¤šæ–‡ä»¶é¢„è§ˆç•Œé¢
   - å‹¾é€‰2ä¸ªè¡¨æ ¼ï¼ˆä¼šæ˜¾ç¤º df1 å’Œ df2ï¼‰
   - è¾“å…¥åˆ†æéœ€æ±‚ï¼Œä¾‹å¦‚ï¼š
     - "å¯¹æ¯”è¿™ä¸¤ä¸ªè¡¨æ ¼çš„å­—æ®µä¸€è‡´æ€§"
     - "æ£€æŸ¥è¿™ä¸¤ä¸ªè¡¨æ ¼æœ‰å“ªäº›å…±åŒå­—æ®µ"
     - "å¯¹æ¯”ç›¸åŒå­—æ®µçš„å–å€¼èŒƒå›´"

4. **é¢„æœŸæ•ˆæœ**
   - AI è‡ªåŠ¨è¯†åˆ« df1 å’Œ df2
   - ç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š
   ```python
   # æŸ¥çœ‹è¡¨æ ¼æ¦‚è§ˆ
   print(f"è¡¨æ ¼ df1: {df1.shape}")
   print(f"è¡¨æ ¼ df2: {df2.shape}")
   
   # æ‰¾å‡ºå…±åŒå­—æ®µ
   common_cols = set(df1.columns) & set(df2.columns)
   print(f"å…±åŒå­—æ®µ: {common_cols}")
   
   # å¯¹æ¯”ç»Ÿè®¡é‡
   for col in common_cols:
       print(f"\nå­—æ®µ '{col}' å¯¹æ¯”:")
       print(f"  df1: å‡å€¼={df1[col].mean():.2f}")
       print(f"  df2: å‡å€¼={df2[col].mean():.2f}")
   ```

---

## ğŸ“ å¾…å®ç°çš„åŠŸèƒ½

### â³ å¤šæ–‡ä»¶å­—æ®µé€‰æ‹©ï¼ˆç”¨æˆ·æ–°éœ€æ±‚ï¼‰

**ç”¨æˆ·éœ€æ±‚**ï¼š
> "ä¸åŒè¡¨æ ¼ä¹Ÿéœ€è¦å¯ä»¥é€‰æ‹©è¡¨çš„å­—æ®µï¼Œä¹Ÿå¸Œæœ›å¦‚æœæœ‰å¤šå¼ è¡¨ä¹Ÿå¯ä»¥é€‰æ‹©ï¼Œç„¶ååœ¨é€‰æ‹©å…¶ä¸­å­—æ®µ"

**å®ç°æ–¹æ¡ˆ**ï¼š

#### 1. æ•°æ®ç»“æ„æ‰©å±•
```javascript
// frontend/src/store/useAppStore.js
selectedTables: [
  {
    file_id: 'xxx',
    sheet_name: 'Sheet1',
    alias: 'df1',
    file_name: 'file1.xlsx',
    selected_columns: ['col1', 'col2', 'col3']  // æ–°å¢
  },
  ...
]
```

#### 2. å‰ç«¯UIæ”¹è¿›
åœ¨ `DataPreview` ç»„ä»¶çš„å¤šæ–‡ä»¶é¢„è§ˆä¸­ï¼š
- å±•ç¤ºæ¯ä¸ªè¡¨æ ¼æ—¶ï¼Œæ˜¾ç¤ºå…¶å­—æ®µåˆ—è¡¨
- å…è®¸ç”¨æˆ·å‹¾é€‰è¦åˆ†æçš„å­—æ®µ
- é€‰ä¸­çš„å­—æ®µéš `selectedTables` ä¸€èµ·ä¼ é€’

#### 3. åç«¯æ”¯æŒ
- Session åˆ›å»ºæ—¶æ¥æ”¶æ¯ä¸ªè¡¨æ ¼çš„ `selected_columns`
- Agent ç”Ÿæˆ prompt æ—¶è€ƒè™‘ç”¨æˆ·é€‰æ‹©çš„å­—æ®µ
- ç”Ÿæˆä»£ç æ—¶åªä½¿ç”¨é€‰ä¸­çš„å­—æ®µ

---

## ğŸ”„ ä¸‹ä¸€æ­¥å»ºè®®

### æ–¹æ¡ˆAï¼šå…ˆæµ‹è¯•å½“å‰åŠŸèƒ½
1. æµ‹è¯•å¤šæ–‡ä»¶ä¸Šä¼ å’ŒåŸºæœ¬åˆ†æ
2. ç¡®è®¤åŠŸèƒ½ç¨³å®šåå†æ·»åŠ å­—æ®µé€‰æ‹©

### æ–¹æ¡ˆBï¼šç«‹å³å®ç°å­—æ®µé€‰æ‹©
1. ä¿®æ”¹ Store æ•°æ®ç»“æ„
2. ä¿®æ”¹ DataPreview UI
3. ä¿®æ”¹ Session åˆ›å»ºé€»è¾‘
4. ä¿®æ”¹ Agent Prompt

**æ¨è**ï¼šå…ˆé€‰æ‹©æ–¹æ¡ˆAæµ‹è¯•å½“å‰åŠŸèƒ½ï¼Œç¡®è®¤åŸºç¡€åŠŸèƒ½ç¨³å®šåå†å®ç°æ–¹æ¡ˆBã€‚

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### å·²ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆæœ¬æ¬¡ä¿®å¤ï¼‰
- âœ… `backend/api/agent.py` - å¤šæ–‡ä»¶æ¨¡å¼æ”¯æŒ
- âœ… `backend/core/agent.py` - Promptæ„å»ºé€»è¾‘
- âœ… `frontend/src/components/WorkArea/WorkArea.jsx` - ç•Œé¢åˆ‡æ¢é€»è¾‘
- âœ… `frontend/src/components/Layout/MainLayout.jsx` - å¸ƒå±€æ”¯æŒ
- âœ… `frontend/src/components/FileUpload/FileUpload.jsx` - ä¸Šä¼ ç•Œé¢ä¼˜åŒ–

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆå­—æ®µé€‰æ‹©åŠŸèƒ½ï¼‰
- â³ `frontend/src/store/useAppStore.js` - æ‰©å±• selectedTables ç»“æ„
- â³ `frontend/src/components/DataPreview/DataPreview.jsx` - æ·»åŠ å­—æ®µé€‰æ‹©UI
- â³ `backend/api/session.py` - æ¥æ”¶å­—æ®µé€‰æ‹©ä¿¡æ¯
- â³ `backend/core/prompts.py` - åœ¨promptä¸­ä½¿ç”¨é€‰ä¸­å­—æ®µ

