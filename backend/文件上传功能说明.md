# 文件上传功能说明

## 概述

科学家团队模式现已支持文件上传，参考豆包和Google Gemini的策略，实现多模态内容理解和智能整合。

## 支持的文件类型

### 1. 数据文件 📊
- **CSV** (.csv)
  - 自动识别编码（UTF-8 / GBK）
  - 提取列名、数据类型、统计摘要
  - 显示前10行预览
  
- **Excel** (.xlsx, .xls)
  - 支持多Sheet解析
  - 提取所有Sheet信息
  - 默认使用第一个Sheet

### 2. 文档文件 📄
- **PDF** (.pdf)
  - 提取文本内容（前5页）
  - 统计页数、字数
  - 显示文本预览

- **Word** (.docx)
  - 提取段落内容
  - 提取表格数据
  - 统计段落数、表格数、字数

- **文本** (.txt, .md)
  - 自动识别编码
  - 提取完整文本
  - 统计行数、字数

## 使用流程

### 前端流程

```
1. 用户点击上传按钮
   ↓
2. 选择文件 (支持拖拽)
   ↓
3. 文件类型和大小验证
   ↓
4. 上传到服务器 (显示进度)
   ↓
5. 服务器解析文件内容
   ↓
6. 返回解析结果
   ↓
7. 显示文件标签（数据/文档，大小）
```

### 后端解析

```python
@router.post("/api/team/upload_file")
async def upload_file(file: UploadFile):
    # 1. 验证文件类型和大小
    # 2. 保存到临时目录
    # 3. 根据类型解析
    #    - CSV/Excel  → pandas
    #    - PDF        → PyPDF2
    #    - Word       → python-docx
    #    - 文本       → 直接读取
    # 4. 返回解析结果
```

## 限制

- **文件大小**：最大 50MB
- **文件数量**：无限制（建议 < 5个）
- **编码支持**：UTF-8, GBK（自动检测）

## 文件解析结果

### 数据文件返回格式
```json
{
  "type": "data",
  "format": "csv",
  "rows": 100,
  "columns": ["col1", "col2", "col3"],
  "summary": {
    "shape": [100, 3],
    "dtypes": {"col1": "int64", "col2": "float64"},
    "head": [...],
    "describe": {...}
  },
  "preview": "前10行预览..."
}
```

### 文档文件返回格式
```json
{
  "type": "document",
  "format": "pdf",
  "pages": 5,
  "text": "文档全文...",
  "preview": "前1000字符...",
  "word_count": 5000
}
```

## AI 整合策略

### 1. 数据文件处理
```
上传数据 → 解析元信息
         ↓
      创建 Jupyter Session
         ↓
      PI 可以：
      - 要求数据分析
      - 生成可视化
      - 统计检验
```

### 2. 文档文件处理
```
上传文档 → 提取文本内容
         ↓
      作为研究上下文
         ↓
      PI 可以：
      - 参考文献综述
      - 理解研究背景
      - 补充课题信息
```

## 前端展示

### 文件标签
```jsx
<Tag color="blue">  // 数据文件
  📎 data.csv (数据, 1.5MB)
</Tag>

<Tag color="green">  // 文档文件
  📎 paper.pdf (文档, 2.3MB)
</Tag>
```

### 消息中的文件信息
```markdown
用户输入的课题...

**附件文件**:

📎 sales_data.csv (1.5MB)
- 数据文件: 1000行 × 5列
- 字段: date, product, quantity, price, revenue

📎 research_paper.pdf (2.3MB)
- 文档: 5000词
- 预览: This paper investigates...
```

## 错误处理

### 文件类型错误
```
❌ 不支持的文件类型。支持：csv, xlsx, xls, pdf, docx, txt, md
```

### 文件大小超限
```
❌ 文件过大（52.3MB），最大支持 50MB
```

### 解析失败
```
❌ CSV解析失败: 无法识别编码
```

## 安装依赖

```bash
cd backend
pip install PyPDF2>=3.0.0 python-docx>=1.1.0
```

已自动添加到 `requirements.txt`

## 使用示例

### 场景1：上传数据进行分析

```
1. 点击📎上传 sales_data.csv
2. 输入："请分析销售趋势并画图"
3. PI识别到数据 → execute_code → 生成图表
```

### 场景2：上传文献作为参考

```
1. 点击📎上传 related_work.pdf
2. 输入："基于这篇论文，研究细胞通信"
3. PI参考文献内容 → search_literature → 补充最新进展
```

### 场景3：上传研究提案

```
1. 点击📎上传 proposal.docx
2. 输入："请评估这个研究提案"
3. PI阅读提案 → consult_expert → 提供改进建议
```

## 技术栈

### 后端
- **FastAPI** - Web框架
- **pandas** - 数据文件解析
- **PyPDF2** - PDF解析
- **python-docx** - Word解析

### 前端
- **Ant Design Upload** - 上传组件
- **axios** - HTTP请求
- **React Hooks** - 状态管理

## API 接口

### POST /api/team/upload_file

**Request:**
```
Content-Type: multipart/form-data
file: <File>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "filename": "data.csv",
    "size": 1536000,
    "type": "data",
    "format": "csv",
    ...
  }
}
```

## 未来扩展

- [ ] 支持图片文件（OCR识别）
- [ ] 支持视频文件（Gemini风格）
- [ ] 支持压缩包（自动解压）
- [ ] 文件内容搜索
- [ ] 文件版本管理
- [ ] 多模态对话（图+文）

---

更新时间：2025-11-06

