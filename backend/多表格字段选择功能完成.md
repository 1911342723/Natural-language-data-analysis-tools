# å¤šè¡¨æ ¼å­—æ®µé€‰æ‹©åŠŸèƒ½ - å®ç°å®Œæˆ âœ…

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç°åœ¨ç”¨æˆ·å¯ä»¥åœ¨å¤šæ–‡ä»¶æ¨¡å¼ä¸‹ï¼Œä¸ºæ¯ä¸ªé€‰ä¸­çš„è¡¨æ ¼å•ç‹¬é€‰æ‹©è¦åˆ†æçš„å­—æ®µï¼

### ğŸ¯ æ–°å¢åŠŸèƒ½

1. **è¡¨æ ¼çº§å­—æ®µé€‰æ‹©**
   - æ¯ä¸ªé€‰ä¸­çš„è¡¨æ ¼éƒ½å¯ä»¥å•ç‹¬å±•å¼€å­—æ®µåˆ—è¡¨
   - æ”¯æŒå‹¾é€‰/å–æ¶ˆå‹¾é€‰å•ä¸ªå­—æ®µ
   - æ”¯æŒ"å…¨é€‰/å–æ¶ˆå…¨é€‰"å¿«æ·æ“ä½œ
   - å®æ—¶æ˜¾ç¤ºé€‰ä¸­å­—æ®µæ•°é‡

2. **æ™ºèƒ½ UI**
   - é»˜è®¤æŠ˜å å­—æ®µåˆ—è¡¨ï¼Œç‚¹å‡»"å±•å¼€"æŸ¥çœ‹
   - æŠ˜å çŠ¶æ€ä¸‹æ˜¾ç¤ºå·²é€‰å­—æ®µåç§°
   - å­—æ®µå¸¦ç±»å‹æ ‡ç­¾ï¼ˆint/float/stringï¼‰
   - å­—æ®µåˆ—è¡¨é‡‡ç”¨ç½‘æ ¼å¸ƒå±€ï¼Œç¾è§‚é«˜æ•ˆ

3. **AI æ™ºèƒ½åˆ†æ**
   - å¦‚æœç”¨æˆ·é€‰æ‹©äº†å­—æ®µï¼ŒAI ä¼šé‡ç‚¹åˆ†æé€‰ä¸­å­—æ®µ
   - å¦‚æœç”¨æˆ·æœªé€‰æ‹©å­—æ®µï¼ŒAI å¯ä»¥ä½¿ç”¨æ‰€æœ‰å­—æ®µ
   - Prompt ä¸­ä¼šæ˜¾ç¤ºç”¨æˆ·é€‰æ‹©çš„å­—æ®µåŠå…¶ç»Ÿè®¡ä¿¡æ¯

---

## ğŸ”§ æŠ€æœ¯å®ç°

### å‰ç«¯ï¼ˆFrontendï¼‰

#### 1. Store æ‰©å±• (`frontend/src/store/useAppStore.js`)

**æ–°å¢çŠ¶æ€**ï¼š
- `selectedTables` ä¸­æ¯ä¸ªè¡¨æ ¼ç°åœ¨åŒ…å« `selected_columns: []`

**æ–°å¢æ–¹æ³•**ï¼š
```javascript
// åˆ‡æ¢è¡¨æ ¼çš„æŸä¸ªå­—æ®µé€‰æ‹©çŠ¶æ€
toggleTableColumn: (fileId, sheetName, columnName) => { ... }

// å…¨é€‰/å–æ¶ˆå…¨é€‰è¡¨æ ¼çš„æ‰€æœ‰å­—æ®µ
toggleAllTableColumns: (fileId, sheetName, allColumns, selectAll) => { ... }

// æ›´æ–°è¡¨æ ¼çš„å­—æ®µé€‰æ‹©ï¼ˆæ‰¹é‡ï¼‰
updateTableColumns: (fileId, sheetName, columns) => { ... }
```

#### 2. DataPreview ç»„ä»¶ (`frontend/src/components/DataPreview/DataPreview.jsx`)

**æ–°å¢åŠŸèƒ½**ï¼š
- æ¯ä¸ªé€‰ä¸­è¡¨æ ¼ä¸‹æ–¹æ˜¾ç¤ºå­—æ®µé€‰æ‹©åŒºåŸŸ
- "å±•å¼€/æ”¶èµ·"æŒ‰é’®æ§åˆ¶å­—æ®µåˆ—è¡¨å¯è§æ€§
- "å…¨é€‰/å–æ¶ˆå…¨é€‰"å¿«æ·æ“ä½œ
- å­—æ®µä»¥ç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºï¼Œå¸¦ç±»å‹æ ‡ç­¾
- æŠ˜å çŠ¶æ€ä¸‹æ˜¾ç¤ºå·²é€‰å­—æ®µåç§°

**UI ç»“æ„**ï¼š
```
[âœ“] è¡¨æ ¼åç§°  [df1]  [3 ä¸ªå­—æ®µ]
    è¡Œæ•°: 2527    åˆ—æ•°: 4
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ”§ é€‰æ‹©è¦åˆ†æçš„å­—æ®µ  [å…¨é€‰] [å±•å¼€]
    
    (å±•å¼€å)
    â˜ store_id (string)
    â˜ cityId (int)
    â˜‘ level (string)
    â˜‘ defect_weight (float)
    
    (æŠ˜å æ—¶)
    å·²é€‰: level, defect_weight
```

#### 3. ChatArea ç»„ä»¶ (`frontend/src/components/ChatArea/ChatArea.jsx`)

**ä¿®æ”¹**ï¼š
- åˆ›å»ºå¤šæ–‡ä»¶ Session æ—¶ä¼ é€’æ¯ä¸ªè¡¨æ ¼çš„ `selected_columns`

```javascript
const tables = selectedTables.map(t => ({
  file_id: t.file_id,
  sheet_name: t.sheet_name,
  alias: t.alias,
  selected_columns: t.selected_columns || []  // âœ… æ–°å¢
}))
```

#### 4. API æœåŠ¡ (`frontend/src/services/api.js`)

**ä¿®æ”¹**ï¼š
- `createMultiSession` ç®€åŒ–å‚æ•°ï¼Œå­—æ®µé€‰æ‹©åœ¨ tables ä¸­ä¼ é€’

---

### åç«¯ï¼ˆBackendï¼‰

#### 1. Session API (`backend/api/session.py`)

**ä¿®æ”¹ `TableSource` æ¨¡å‹**ï¼š
```python
class TableSource(BaseModel):
    file_id: str
    sheet_name: str
    alias: str
    selected_columns: Optional[List[str]] = []  # âœ… æ–°å¢
```

**ä¿®æ”¹ `create_multi_session`**ï¼š
- ä»æ¯ä¸ª `table_req` ä¸­æå– `selected_columns`
- å­˜å‚¨åˆ° `tables_data` ä¸­
- è®°å½•æ—¥å¿—æ˜¾ç¤ºæ¯ä¸ªè¡¨æ ¼çš„é€‰ä¸­å­—æ®µæ•°é‡

#### 2. Agent API (`backend/api/agent.py`)

**ä¿®æ”¹ `analyze_stream`**ï¼š
- æ„å»º `tables_info` æ—¶åŒ…å« `selected_columns`
- è®°å½•æ—¥å¿—æ˜¾ç¤ºæ¯ä¸ªè¡¨æ ¼çš„é€‰ä¸­å­—æ®µæ•°é‡

```python
for table in session_info.get('tables', []):
    selected_columns = table.get('selected_columns', [])
    tables_info.append({
        'alias': table['alias'],
        'file_name': table['file_name'],
        'sheet_name': table['sheet_name'],
        'total_rows': sheet['total_rows'],
        'total_columns': sheet['total_columns'],
        'columns': sheet['columns'],
        'selected_columns': selected_columns  # âœ… æ–°å¢
    })
    logger.info(f"  - è¡¨æ ¼ {table['alias']}: {len(selected_columns)} ä¸ªé€‰ä¸­å­—æ®µ")
```

#### 3. Prompts (`backend/core/prompts.py`)

**å¢å¼º `build_initial_prompt`**ï¼š
- æ£€æµ‹ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†å­—æ®µ
- å¦‚æœé€‰æ‹©äº†å­—æ®µï¼š
  - æ˜¾ç¤ºé€‰ä¸­å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼ˆç±»å‹ã€ç»Ÿè®¡é‡ï¼‰
  - æç¤º "ç”¨æˆ·é€‰æ‹©çš„å­—æ®µï¼ˆå…±Nä¸ªï¼‰"
- å¦‚æœæœªé€‰æ‹©å­—æ®µï¼š
  - æ˜¾ç¤ºæ‰€æœ‰å­—æ®µï¼ˆç®€åŒ–ç‰ˆï¼‰
  - æç¤º "ç”¨æˆ·æœªé€‰æ‹©ç‰¹å®šå­—æ®µï¼Œå¯ä½¿ç”¨æ‰€æœ‰å­—æ®µè¿›è¡Œåˆ†æ"

**ç¤ºä¾‹è¾“å‡º**ï¼š

æœ‰å­—æ®µé€‰æ‹©æ—¶ï¼š
```
**è¡¨æ ¼ df1**:
  - æ¥æº: å•†æˆ·27.xlsx / Sheet1
  - è¡Œæ•°: 2527
  - ç”¨æˆ·é€‰æ‹©çš„å­—æ®µï¼ˆå…±2ä¸ªï¼‰:
    level (string) [å”¯ä¸€å€¼: 5]
    defect_weight (float) [èŒƒå›´: 0.0-1.0, å‡å€¼: 0.45]
```

æ— å­—æ®µé€‰æ‹©æ—¶ï¼š
```
**è¡¨æ ¼ df1**:
  - æ¥æº: å•†æˆ·27.xlsx / Sheet1
  - è¡Œæ•°: 2527
  - æ‰€æœ‰å­—æ®µ: store_id, cityId, level, defect_weight
  - **æ³¨æ„**: ç”¨æˆ·æœªé€‰æ‹©ç‰¹å®šå­—æ®µï¼Œå¯ä½¿ç”¨æ‰€æœ‰å­—æ®µè¿›è¡Œåˆ†æ
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡

**åç«¯**ï¼š
```bash
cd backend
python main.py
```

**å‰ç«¯**ï¼š
```bash
cd frontend
npm run dev
```

### 2. ä¸Šä¼ å¤šæ–‡ä»¶

1. åˆ‡æ¢åˆ°"å¤šæ–‡ä»¶å¯¹æ¯”"æ¨¡å¼
2. ä¸Šä¼  2 ä¸ªæ–‡ä»¶ï¼ˆä¾‹å¦‚ `BI-27.xlsx` å’Œ `å•†æˆ·27.xlsx`ï¼‰
3. âœ… åº”è‡ªåŠ¨è·³è½¬åˆ°æ•°æ®é¢„è§ˆç•Œé¢

### 3. é€‰æ‹©è¡¨æ ¼å’Œå­—æ®µ

1. å‹¾é€‰ç¬¬ä¸€ä¸ªè¡¨æ ¼ï¼ˆä¼šæ˜¾ç¤º `df1`ï¼‰
2. ç‚¹å‡»"å±•å¼€"ï¼Œå‹¾é€‰ 1-2 ä¸ªå­—æ®µï¼ˆå¦‚ `level`, `defect_weight`ï¼‰
3. å‹¾é€‰ç¬¬äºŒä¸ªè¡¨æ ¼ï¼ˆä¼šæ˜¾ç¤º `df2`ï¼‰
4. ç‚¹å‡»"å±•å¼€"ï¼Œå‹¾é€‰ä¸åŒçš„å­—æ®µï¼ˆå¦‚ `store_id`, `cityId`ï¼‰

### 4. æäº¤åˆ†æéœ€æ±‚

è¾“å…¥åˆ†æéœ€æ±‚ï¼Œä¾‹å¦‚ï¼š
- "å¯¹æ¯”è¿™ä¸¤ä¸ªè¡¨æ ¼é€‰ä¸­å­—æ®µçš„æ•°æ®åˆ†å¸ƒ"
- "åˆ†æ df1 çš„ level å­—æ®µå’Œ df2 çš„ store_id å­—æ®µ"
- "å¯¹æ¯”ä¸¤ä¸ªè¡¨æ ¼çš„å­—æ®µä¸€è‡´æ€§"

### 5. æ£€æŸ¥ AI ç”Ÿæˆçš„ä»£ç 

**é¢„æœŸæ•ˆæœ**ï¼š
- AI åº”è¯¥ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·é€‰ä¸­çš„å­—æ®µ
- å¦‚æœç”¨æˆ·æœªé€‰æ‹©å­—æ®µï¼ŒAI å¯ä»¥ä½¿ç”¨æ‰€æœ‰å­—æ®µ
- ç”Ÿæˆçš„ä»£ç åº”è¯¥æ­£ç¡®å¼•ç”¨ `df1[é€‰ä¸­å­—æ®µ]` å’Œ `df2[é€‰ä¸­å­—æ®µ]`

---

## ğŸ“Š æ•°æ®æµå›¾

```
å‰ç«¯ç”¨æˆ·æ“ä½œ
   â†“
å‹¾é€‰è¡¨æ ¼å’Œå­—æ®µ
   â†“
selectedTables = [
  { file_id, sheet_name, alias: 'df1', selected_columns: ['level', 'defect_weight'] },
  { file_id, sheet_name, alias: 'df2', selected_columns: ['store_id'] }
]
   â†“
ç‚¹å‡»"å¼€å§‹åˆ†æ"
   â†“
createMultiSession(group_id, tables) â†’ åç«¯ /session/create-multi
   â†“
åç«¯æ”¶é›† selected_columns
   â†“
åˆ›å»º Jupyter Sessionï¼ˆåŠ è½½ df1, df2ï¼‰
   â†“
ç¼“å­˜ session_infoï¼ˆåŒ…å« tables å’Œ selected_columnsï¼‰
   â†“
å‰ç«¯æäº¤åˆ†æéœ€æ±‚ â†’ åç«¯ /agent/analyze-stream
   â†“
åç«¯ä» session_info æå– tables å’Œ selected_columns
   â†“
æ„å»º data_schemaï¼ˆåŒ…å«æ¯ä¸ªè¡¨æ ¼çš„ selected_columnsï¼‰
   â†“
ç”Ÿæˆ AI Promptï¼ˆæ ¹æ® selected_columns å®šåˆ¶ï¼‰
   â†“
AI ç”Ÿæˆä»£ç ï¼ˆä¼˜å…ˆä½¿ç”¨é€‰ä¸­å­—æ®µï¼‰
   â†“
Jupyter æ‰§è¡Œä»£ç 
   â†“
è¿”å›ç»“æœç»™å‰ç«¯
```

---

## ğŸ‰ åŠŸèƒ½äº®ç‚¹

### 1. çµæ´»æ€§
- æ¯ä¸ªè¡¨æ ¼å¯ä»¥å•ç‹¬é€‰æ‹©å­—æ®µ
- å¯ä»¥é€‰æ‹©ä¸åŒçš„å­—æ®µè¿›è¡Œå¯¹æ¯”åˆ†æ
- æ”¯æŒ"å…¨é€‰"å¿«æ·æ“ä½œ

### 2. æ™ºèƒ½æ€§
- AI æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„å­—æ®µç”Ÿæˆæ›´ç²¾å‡†çš„åˆ†æä»£ç 
- è‡ªåŠ¨æ˜¾ç¤ºå­—æ®µç±»å‹å’Œç»Ÿè®¡ä¿¡æ¯
- æœªé€‰æ‹©å­—æ®µæ—¶ä¸é™åˆ¶ AI ä½¿ç”¨èŒƒå›´

### 3. ç”¨æˆ·ä½“éªŒ
- ç›´è§‚çš„ UIï¼šå±•å¼€/æŠ˜å ã€å…¨é€‰/å–æ¶ˆå…¨é€‰
- å®æ—¶åé¦ˆï¼šæ˜¾ç¤ºé€‰ä¸­å­—æ®µæ•°é‡
- æ¸…æ™°çš„æç¤ºï¼šæŠ˜å æ—¶æ˜¾ç¤ºå·²é€‰å­—æ®µåç§°

### 4. æ‰©å±•æ€§
- Store æ–¹æ³•è®¾è®¡æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•
- åç«¯ API å…¼å®¹æ€§è‰¯å¥½
- Prompt æ¨¡æ¿æ”¯æŒçµæ´»å®šåˆ¶

---

## ğŸ“ ä»£ç æ”¹åŠ¨æ¸…å•

### å‰ç«¯æ–‡ä»¶

1. âœ… `frontend/src/store/useAppStore.js`
   - æ·»åŠ  `toggleTableColumn`
   - æ·»åŠ  `toggleAllTableColumns`
   - æ·»åŠ  `updateTableColumns`

2. âœ… `frontend/src/components/DataPreview/DataPreview.jsx`
   - æ·»åŠ å­—æ®µé€‰æ‹© UI
   - å±•å¼€/æŠ˜å åŠŸèƒ½
   - å…¨é€‰/å–æ¶ˆå…¨é€‰åŠŸèƒ½

3. âœ… `frontend/src/components/ChatArea/ChatArea.jsx`
   - ä¼ é€’ `selected_columns` åˆ° `createMultiSession`

4. âœ… `frontend/src/services/api.js`
   - ç®€åŒ– `createMultiSession` å‚æ•°

### åç«¯æ–‡ä»¶

5. âœ… `backend/api/session.py`
   - `TableSource` æ·»åŠ  `selected_columns` å­—æ®µ
   - `create_multi_session` æå–å¹¶å­˜å‚¨ `selected_columns`

6. âœ… `backend/api/agent.py`
   - `analyze_stream` æ„å»º `tables_info` æ—¶åŒ…å« `selected_columns`

7. âœ… `backend/core/prompts.py`
   - `build_initial_prompt` æ ¹æ® `selected_columns` å®šåˆ¶è¾“å‡º

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### å¯é€‰å¢å¼ºåŠŸèƒ½

1. **å­—æ®µæ™ºèƒ½æ¨è**
   - åˆ†æå¤šä¸ªè¡¨æ ¼ï¼Œè‡ªåŠ¨æ¨èå…±åŒå­—æ®µ
   - é«˜äº®æ˜¾ç¤ºç±»å‹ä¸€è‡´çš„å­—æ®µ

2. **å­—æ®µå¯¹é½åŠŸèƒ½**
   - è‡ªåŠ¨è¯†åˆ«ä¸åŒè¡¨æ ¼çš„ç›¸ä¼¼å­—æ®µï¼ˆå¦‚ `user_id` vs `userId`ï¼‰
   - æä¾›å­—æ®µæ˜ å°„åŠŸèƒ½

3. **é¢„è®¾åˆ†ææ¨¡æ¿**
   - "æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥"ï¼šè‡ªåŠ¨é€‰æ‹©å…±åŒå­—æ®µ
   - "æ•°æ®è´¨é‡å¯¹æ¯”"ï¼šè‡ªåŠ¨é€‰æ‹©æ‰€æœ‰æ•°å€¼å­—æ®µ
   - "å­—æ®µè¦†ç›–ç‡åˆ†æ"ï¼šè‡ªåŠ¨é€‰æ‹©æ‰€æœ‰å­—æ®µ

4. **å­—æ®µæœç´¢åŠŸèƒ½**
   - åœ¨å­—æ®µåˆ—è¡¨ä¸­æ·»åŠ æœç´¢æ¡†
   - å¿«é€Ÿç­›é€‰ç›®æ ‡å­—æ®µ

---

## âœ… å®ŒæˆçŠ¶æ€

- [x] å‰ç«¯ Store æ‰©å±•
- [x] å‰ç«¯ UI å®ç°
- [x] å‰ç«¯ API è°ƒç”¨ä¿®æ”¹
- [x] åç«¯ Session API ä¿®æ”¹
- [x] åç«¯ Agent API ä¿®æ”¹
- [x] åç«¯ Prompt å¢å¼º
- [x] æ–‡æ¡£ç¼–å†™

**æ‰€æœ‰åŠŸèƒ½å·²å®ç°ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼** ğŸ‰

