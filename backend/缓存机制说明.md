# æ–‡ä»¶å’Œç¼“å­˜æœºåˆ¶è¯´æ˜

## ğŸ“ æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆ

### å½“å‰å®ç°ï¼ˆå†…å­˜ç¼“å­˜ + æœ¬åœ°æ–‡ä»¶ï¼‰

```
ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
    â†“
1. ä¿å­˜åˆ°æœ¬åœ°ç›®å½•
   ./uploads/{file_id}.csv
    â†“
2. è§£ææ–‡ä»¶è·å–å…ƒä¿¡æ¯
   - columns (å­—æ®µä¿¡æ¯)
   - preview (å‰100è¡Œ)
   - data_json (å®Œæ•´æ•°æ®JSON)
    â†“
3. ç¼“å­˜åˆ°å†…å­˜
   file_cache[file_id] = file_info
    â†“
4. è¿”å›å‰ç«¯
   (ä¸å« data_jsonï¼Œå‡å°‘ä¼ è¾“)
```

### æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ uploads/                      # æœ¬åœ°æ–‡ä»¶å­˜å‚¨
â”‚   â”œâ”€â”€ abc123.csv
â”‚   â”œâ”€â”€ def456.xlsx
â”‚   â””â”€â”€ ...
â”œâ”€â”€ data/                         # æ•°æ®åº“ï¼ˆå†å²è®°å½•ï¼‰
â”‚   â””â”€â”€ analysis.db
â””â”€â”€ core/
    â””â”€â”€ cache.py                  # å†…å­˜ç¼“å­˜ç®¡ç†
```

---

## ğŸ”„ ç¼“å­˜æ¶æ„

### 1. æ–‡ä»¶ç¼“å­˜ (FileCache)

**ç”¨é€”ï¼š** ç¼“å­˜ä¸Šä¼ æ–‡ä»¶çš„å…ƒä¿¡æ¯å’Œå®Œæ•´æ•°æ®

**å­˜å‚¨å†…å®¹ï¼š**
```python
file_cache[file_id] = {
    'file_id': 'abc123',
    'file_name': 'sales.csv',
    'file_size': 123456,
    'total_rows': 1000,
    'total_columns': 10,
    'columns': [
        {
            'name': 'é”€å”®é¢',
            'type': 'float',
            'nullable': False,
            'stats': {'min': 100, 'max': 50000}
        },
        ...
    ],
    'preview': [...],  # å‰100è¡Œæ•°æ®
    'data_json': '...'  # å®Œæ•´æ•°æ®JSONï¼ˆç”¨äºåˆ›å»ºSessionï¼‰
}
```

**ç”Ÿå‘½å‘¨æœŸï¼š**
- åˆ›å»ºï¼šæ–‡ä»¶ä¸Šä¼ æˆåŠŸæ—¶
- ä½¿ç”¨ï¼šåˆ›å»º Jupyter Session æ—¶
- æ¸…ç†ï¼šæ‰‹åŠ¨æ¸…ç†æˆ–æœåŠ¡é‡å¯

### 2. Session ç¼“å­˜ (SessionCache)

**ç”¨é€”ï¼š** ç¼“å­˜ Jupyter Session ä¿¡æ¯

**å­˜å‚¨å†…å®¹ï¼š**
```python
session_cache[session_id] = {
    'session_id': 'xyz789',
    'file_id': 'abc123',
    'file_name': 'sales.csv',
    'selected_columns': ['é”€å”®é¢', 'åœ°åŒº'],
    'created_at': datetime.now()
}
```

**ç”Ÿå‘½å‘¨æœŸï¼š**
- åˆ›å»ºï¼šåˆ›å»º Jupyter Session æ—¶
- ä½¿ç”¨ï¼šæäº¤åˆ†æè¯·æ±‚æ—¶ï¼ˆè·å– file_idï¼‰
- æ¸…ç†ï¼šå…³é—­ Session æ—¶æˆ–æ‰‹åŠ¨æ¸…ç†

---

## ğŸ”‘ API å¯†é’¥ç®¡ç†

### âš ï¸ é‡è¦æé†’

**æ°¸è¿œä¸è¦å°† API å¯†é’¥ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼**

```python
# âŒ é”™è¯¯åšæ³•ï¼ˆåœ¨ config.py ä¸­ç¡¬ç¼–ç ï¼‰
openai_api_key: str = Field(default="sk-xxxxxxxxxx")

# âœ… æ­£ç¡®åšæ³•ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
openai_api_key: str = Field(default="", alias="OPENAI_API_KEY")
```

### é…ç½®æ­¥éª¤

1. **å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿**
   ```bash
   cp .env.example .env
   ```

2. **ç¼–è¾‘ `.env` æ–‡ä»¶**
   ```env
   # .env æ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ° Gitï¼‰
   OPENAI_API_KEY=your_actual_key_here
   OPENAI_MODEL=gpt-4o-mini
   ```

3. **`.gitignore` å·²é…ç½®**
   ```gitignore
   .env
   ```

4. **åº”ç”¨è¯»å–é…ç½®**
   ```python
   from config import settings
   
   # è‡ªåŠ¨ä» .env è¯»å–
   api_key = settings.openai_api_key
   ```

---

## ğŸ“Š æ•°æ®æµç¨‹

### å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   1. æ–‡ä»¶ä¸Šä¼                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‰ç«¯ â†’ åç«¯ /api/upload                             â”‚
â”‚ â”œâ”€ ä¿å­˜åˆ°æœ¬åœ°: ./uploads/{file_id}.csv             â”‚
â”‚ â”œâ”€ è§£ææ–‡ä»¶: pandas.read_csv()                     â”‚
â”‚ â””â”€ ç¼“å­˜ä¿¡æ¯: file_cache.set(file_id, file_info)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               2. åˆ›å»º Jupyter Session                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‰ç«¯ â†’ åç«¯ /api/session/create                     â”‚
â”‚ â”œâ”€ ä»ç¼“å­˜è·å–: file_info = file_cache.get(file_id) â”‚
â”‚ â”œâ”€ åˆ›å»º Kernel: jupyter_manager.create_session()   â”‚
â”‚ â”œâ”€ åŠ è½½æ•°æ®: df = pd.read_json(data_json)          â”‚
â”‚ â””â”€ ç¼“å­˜ Session: session_cache.set(session_id, ...) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 3. æäº¤åˆ†æè¯·æ±‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‰ç«¯ â†’ åç«¯ /api/agent/analyze                      â”‚
â”‚ â”œâ”€ ä»ç¼“å­˜è·å– Session: session_cache.get()         â”‚
â”‚ â”œâ”€ ä»ç¼“å­˜è·å–æ–‡ä»¶: file_cache.get()                â”‚
â”‚ â”œâ”€ å¯åŠ¨ Agent: agent.run()                         â”‚
â”‚ â”‚   â”œâ”€ AI ç”Ÿæˆä»£ç                                  â”‚
â”‚ â”‚   â”œâ”€ Jupyter æ‰§è¡Œä»£ç                             â”‚
â”‚ â”‚   â””â”€ è¿”å›ç»“æœ                                    â”‚
â”‚ â””â”€ è¿”å› task_id                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               4. è½®è¯¢è·å–çŠ¶æ€                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‰ç«¯ â†’ åç«¯ /api/agent/status/{task_id}             â”‚
â”‚ â””â”€ è¿”å›å®æ—¶æ­¥éª¤å’Œç»“æœ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä¼˜åŠ¿

### å½“å‰æ–¹æ¡ˆä¼˜åŠ¿

âœ… **å¿«é€Ÿå¼€å‘æµ‹è¯•**
- æ— éœ€é…ç½®æ•°æ®åº“
- æ–‡ä»¶ç›´æ¥å­˜å‚¨åœ¨æœ¬åœ°
- é‡å¯åç¼“å­˜ä¸¢å¤±ï¼ˆæµ‹è¯•é˜¶æ®µå¯æ¥å—ï¼‰

âœ… **æ€§èƒ½ä¼˜ç§€**
- å†…å­˜è¯»å–é€Ÿåº¦å¿«
- å‡å°‘æ•°æ®åº“ I/O

âœ… **å®ç°ç®€å•**
- ä»£ç é€»è¾‘æ¸…æ™°
- æ˜“äºè°ƒè¯•

### å±€é™æ€§

âš ï¸ **é‡å¯ä¸¢å¤±**
- æœåŠ¡é‡å¯åç¼“å­˜æ¸…ç©º
- éœ€è¦é‡æ–°ä¸Šä¼ æ–‡ä»¶

âš ï¸ **å†…å­˜å ç”¨**
- æ–‡ä»¶æ•°æ®å…¨éƒ¨åŠ è½½åˆ°å†…å­˜
- å¤§æ–‡ä»¶å¯èƒ½å ç”¨è¾ƒå¤šå†…å­˜

âš ï¸ **æ— æŒä¹…åŒ–**
- æ–‡ä»¶å…ƒä¿¡æ¯æœªæŒä¹…åŒ–
- æ— æ³•æ¢å¤å†å²çŠ¶æ€

---

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šRedis ç¼“å­˜ï¼ˆæ¨èï¼‰

```python
# ä½¿ç”¨ Redis æ›¿ä»£å†…å­˜ç¼“å­˜
import redis
from redis import asyncio as aioredis

redis_client = aioredis.from_url("redis://localhost")

# ç¼“å­˜æ–‡ä»¶ä¿¡æ¯ï¼ˆ1å°æ—¶è¿‡æœŸï¼‰
await redis_client.setex(
    f"file:{file_id}",
    3600,
    json.dumps(file_info)
)

# è·å–
file_info = json.loads(
    await redis_client.get(f"file:{file_id}")
)
```

**ä¼˜åŠ¿ï¼š**
- âœ… é‡å¯åæ•°æ®ä¸ä¸¢å¤±
- âœ… æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- âœ… è‡ªåŠ¨è¿‡æœŸæ¸…ç†

### æ–¹æ¡ˆBï¼šæ•°æ®åº“å­˜å‚¨

```python
# å°†æ–‡ä»¶å…ƒä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“
class UploadedFile(Base):
    __tablename__ = "uploaded_files"
    
    file_id = Column(String, primary_key=True)
    file_name = Column(String)
    file_path = Column(String)
    file_size = Column(Integer)
    metadata = Column(JSON)  # å­—æ®µä¿¡æ¯ç­‰
    data_json = Column(Text)  # å®Œæ•´æ•°æ®
    created_at = Column(DateTime)
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ°¸ä¹…å­˜å‚¨
- âœ… å¯æŸ¥è¯¢å†å²
- âœ… æ”¯æŒå…³è”å…³ç³»

### æ–¹æ¡ˆCï¼šå¯¹è±¡å­˜å‚¨ï¼ˆå¤§è§„æ¨¡ï¼‰

```python
# ä½¿ç”¨ OSS/S3 å­˜å‚¨æ–‡ä»¶
import boto3

s3_client = boto3.client('s3')
s3_client.upload_file(
    local_path,
    bucket='my-bucket',
    key=f'uploads/{file_id}.csv'
)
```

**ä¼˜åŠ¿ï¼š**
- âœ… æµ·é‡æ–‡ä»¶å­˜å‚¨
- âœ… é«˜å¯ç”¨
- âœ… CDN åŠ é€Ÿ

---

## ğŸ“ ä½¿ç”¨å»ºè®®

### å¼€å‘/æµ‹è¯•é˜¶æ®µï¼ˆå½“å‰ï¼‰

```bash
# å¯åŠ¨æœåŠ¡
python main.py

# æµ‹è¯•ä¸Šä¼ 
curl -X POST http://localhost:8000/api/upload \
  -F "file=@test.csv"

# æŸ¥çœ‹ç¼“å­˜ï¼ˆæ·»åŠ è°ƒè¯•æ¥å£ï¼‰
curl http://localhost:8000/api/debug/cache
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆå»ºè®®ï¼‰

1. **ä½¿ç”¨ Redis**
   ```bash
   # å®‰è£… Redis
   pip install redis

   # ä¿®æ”¹ cache.py ä½¿ç”¨ Redis
   ```

2. **æ–‡ä»¶æ¸…ç†ç­–ç•¥**
   ```python
   # å®šæ—¶æ¸…ç†è¿‡æœŸæ–‡ä»¶
   import schedule
   
   def cleanup_old_files():
       # åˆ é™¤ 24 å°æ—¶å‰çš„æ–‡ä»¶
       pass
   
   schedule.every().day.at("02:00").do(cleanup_old_files)
   ```

3. **ç›‘æ§ç¼“å­˜å¤§å°**
   ```python
   # æ·»åŠ ç›‘æ§
   logger.info(f"å½“å‰ç¼“å­˜å¤§å°: {file_cache.size()}")
   logger.info(f"Session æ•°é‡: {session_cache.size()}")
   ```

---

## ğŸ”§ è°ƒè¯•æ¥å£ï¼ˆå¯é€‰ï¼‰

æ·»åŠ è°ƒè¯•æ¥å£æŸ¥çœ‹ç¼“å­˜çŠ¶æ€ï¼š

```python
# backend/api/debug.py
@router.get("/debug/cache")
async def get_cache_status():
    """æŸ¥çœ‹ç¼“å­˜çŠ¶æ€ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰"""
    if not settings.debug:
        raise HTTPException(403, "ä»…å¼€å‘ç¯å¢ƒå¯ç”¨")
    
    return {
        "file_cache_size": file_cache.size(),
        "session_cache_size": session_cache.size(),
    }
```

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-30  
**å½“å‰çŠ¶æ€**: âœ… å†…å­˜ç¼“å­˜æ–¹æ¡ˆå·²å®ç°  
**ä¸‹ä¸€æ­¥**: æµ‹è¯•é€šè¿‡åè€ƒè™‘ Redis æ–¹æ¡ˆ


