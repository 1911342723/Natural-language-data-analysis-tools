# å¤šæ–‡ä»¶ä¸Šä¼ ä¸ä¸€è‡´æ€§åˆ†æåŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ”¯æŒä¸Šä¼ å¤šä¸ªè¡¨æ ¼æ–‡ä»¶ï¼Œè¿›è¡Œè·¨è¡¨æ ¼çš„ä¸€è‡´æ€§åˆ†æï¼ŒåŒ…æ‹¬ï¼š
- æ•°æ®ç±»å‹ä¸€è‡´æ€§æ£€æŸ¥
- å–å€¼èŒƒå›´å¯¹æ¯”
- ç¼ºå¤±å€¼/é‡å¤å€¼å¯¹æ¯”
- å­—æ®µåˆ†å¸ƒå·®å¼‚åˆ†æ
- å…³è”æ•°æ®å¯¹æ¯”ï¼ˆå¦‚æœ‰å…±åŒIDï¼‰

---

## ğŸ”§ åç«¯æ¶æ„

### 1. æ–‡ä»¶ä¸Šä¼ 

#### å•æ–‡ä»¶ä¸Šä¼ ï¼ˆä¿æŒå…¼å®¹ï¼‰
- **æ¥å£**ï¼š`POST /api/upload`
- **å‚æ•°**ï¼šå•ä¸ªæ–‡ä»¶
- **è¿”å›**ï¼š`{ file_id, file_name, sheets: [...] }`

#### å¤šæ–‡ä»¶ä¸Šä¼ ï¼ˆæ–°åŠŸèƒ½ï¼‰
- **æ¥å£**ï¼š`POST /api/upload-multiple`
- **å‚æ•°**ï¼šæ–‡ä»¶æ•°ç»„ï¼ˆæœ€å¤š10ä¸ªï¼‰
- **è¿”å›**ï¼š`{ group_id, files: [{file_id, file_name, sheets: [...]}, ...] }`
- **å®ç°**ï¼š`backend/api/upload.py`

### 2. Session åˆ›å»º

#### å•æ–‡ä»¶ Sessionï¼ˆä¿æŒå…¼å®¹ï¼‰
- **æ¥å£**ï¼š`POST /api/session/create`
- **å‚æ•°**ï¼š
  ```json
  {
    "file_id": "xxx",
    "sheet_name": "Sheet1",
    "selected_columns": ["col1", "col2"]
  }
  ```

#### å¤šæ–‡ä»¶ Sessionï¼ˆæ–°åŠŸèƒ½ï¼‰
- **æ¥å£**ï¼š`POST /api/session/create-multi`
- **å‚æ•°**ï¼š
  ```json
  {
    "group_id": "xxx",
    "tables": [
      {"file_id": "file1", "sheet_name": "Sheet1", "alias": "df1"},
      {"file_id": "file2", "sheet_name": "Sheet1", "alias": "df2"}
    ],
    "selected_columns": []
  }
  ```
- **å®ç°**ï¼š`backend/api/session.py`

### 3. Jupyter Kernel ç®¡ç†

#### å¤šDataFrameåŠ è½½
- **æ–¹æ³•**ï¼š`JupyterManager.create_multi_session(tables_data)`
- **åŠŸèƒ½**ï¼šåœ¨Jupyterä¸­åŠ è½½å¤šä¸ªDataFrameï¼ˆdf1, df2, df3...ï¼‰
- **å®ç°**ï¼š`backend/core/jupyter_manager.py`

```python
# ç¤ºä¾‹ï¼šåŠ è½½3ä¸ªè¡¨æ ¼
tables_data = [
    {'alias': 'df1', 'data_json': '...', 'file_name': 'file1.csv'},
    {'alias': 'df2', 'data_json': '...', 'file_name': 'file2.csv'},
    {'alias': 'df3', 'data_json': '...', 'file_name': 'file3.csv'}
]
session_id = await jupyter_manager.create_multi_session(tables_data)
```

### 4. AI Prompt å¢å¼º

- **ä½ç½®**ï¼š`backend/core/prompts.py`
- **åŠŸèƒ½**ï¼š`build_initial_prompt()` æ”¯æŒ `tables_info` å‚æ•°
- **å¤šè¡¨æ ¼åˆ†ææŒ‡å¯¼**ï¼š
  1. è¡¨æ ¼æ¦‚è§ˆå¯¹æ¯”
  2. å­—æ®µæ˜ å°„è¯†åˆ«
  3. ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆç±»å‹ã€èŒƒå›´ã€æšä¸¾å€¼ï¼‰
  4. å®Œæ•´æ€§æ£€æŸ¥ï¼ˆç¼ºå¤±å€¼ã€é‡å¤å€¼ï¼‰
  5. å·®å¼‚åˆ†æï¼ˆç»Ÿè®¡é‡ã€åˆ†å¸ƒï¼‰
  6. å¼‚å¸¸è¯†åˆ«
  7. å…³è”åˆ†æï¼ˆå…±åŒIDå¯¹æ¯”ï¼‰

---

## ğŸ¨ å‰ç«¯æ¶æ„

### 1. Store çŠ¶æ€ç®¡ç†

**æ–°å¢çŠ¶æ€**ï¼ˆ`frontend/src/store/useAppStore.js`ï¼‰ï¼š
```javascript
{
  uploadMode: 'single' | 'multiple',  // ä¸Šä¼ æ¨¡å¼
  fileGroup: {                         // æ–‡ä»¶ç»„ä¿¡æ¯
    group_id: 'xxx',
    files: [{file_id, file_name, sheets}, ...]
  },
  selectedTables: [                    // ç”¨æˆ·é€‰æ‹©çš„è¡¨æ ¼
    {file_id, sheet_name, alias: 'df1', file_name},
    ...
  ]
}
```

**æ–°å¢æ–¹æ³•**ï¼š
- `setUploadMode(mode)` - è®¾ç½®ä¸Šä¼ æ¨¡å¼
- `setFileGroup(group)` - è®¾ç½®æ–‡ä»¶ç»„
- `toggleTable(table)` - æ·»åŠ /ç§»é™¤è¡¨æ ¼é€‰æ‹©
- `clearSelectedTables()` - æ¸…ç©ºè¡¨æ ¼é€‰æ‹©

### 2. FileUpload ç»„ä»¶ï¼ˆå¾…å®ç°ï¼‰

**åŠŸèƒ½**ï¼š
- åˆ‡æ¢å•æ–‡ä»¶/å¤šæ–‡ä»¶ä¸Šä¼ æ¨¡å¼
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
- æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
- è°ƒç”¨ `/api/upload-multiple` æ¥å£

### 3. DataPreview ç»„ä»¶ï¼ˆå¾…å®ç°ï¼‰

**å•æ–‡ä»¶æ¨¡å¼**ï¼š
- æ˜¾ç¤ºå½“å‰æ–‡ä»¶çš„æ‰€æœ‰å·¥ä½œè¡¨
- åˆ‡æ¢å·¥ä½œè¡¨æŸ¥çœ‹é¢„è§ˆ

**å¤šæ–‡ä»¶æ¨¡å¼**ï¼š
- æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶å’Œå·¥ä½œè¡¨
- æ”¯æŒå‹¾é€‰å¤šä¸ªè¡¨æ ¼
- æ˜¾ç¤ºé€‰ä¸­çš„è¡¨æ ¼åŠå…¶aliasï¼ˆdf1, df2...ï¼‰

### 4. ChatArea ç»„ä»¶ï¼ˆå¾…å®ç°ï¼‰

**å¤šæ–‡ä»¶æ¨¡å¼**ï¼š
- åˆ›å»ºSessionæ—¶è°ƒç”¨ `/api/session/create-multi`
- ä¼ é€’ `group_id` å’Œ `selectedTables`
- Agentåˆ†ææ—¶æç¤ºç”¨æˆ·è¿›è¡Œä¸€è‡´æ€§åˆ†æ

---

## ğŸ§ª æµ‹è¯•æµç¨‹

### å•æ–‡ä»¶æµ‹è¯•ï¼ˆç°æœ‰åŠŸèƒ½ï¼‰
1. ä¸Šä¼  CSV/Excel æ–‡ä»¶
2. é€‰æ‹©å·¥ä½œè¡¨å’Œå­—æ®µ
3. åˆ›å»º Session
4. è¿›è¡Œæ•°æ®åˆ†æ

### å¤šæ–‡ä»¶æµ‹è¯•ï¼ˆæ–°åŠŸèƒ½ï¼‰
1. åˆ‡æ¢åˆ°"å¤šæ–‡ä»¶æ¨¡å¼"
2. ä¸Šä¼  2-3 ä¸ª CSV/Excel æ–‡ä»¶
3. å‹¾é€‰è¦åˆ†æçš„è¡¨æ ¼ï¼ˆè‡ªåŠ¨åˆ†é… df1, df2, df3ï¼‰
4. åˆ›å»ºå¤šæ–‡ä»¶ Session
5. è¾“å…¥åˆ†æéœ€æ±‚ï¼š
   - "å¯¹æ¯”è¿™å‡ ä¸ªè¡¨æ ¼çš„æ•°æ®ä¸€è‡´æ€§"
   - "æ‰¾å‡ºå­—æ®µ'score'åœ¨å„è¡¨ä¸­çš„å·®å¼‚"
   - "æ£€æŸ¥è¿™äº›è¡¨æ ¼çš„æ•°æ®è´¨é‡"
6. AI è‡ªåŠ¨ç”Ÿæˆä»£ç å¹¶æ‰§è¡Œåˆ†æ

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šå¯¹æ¯”å¤šä¸ªé—¨åº—çš„é”€å”®æ•°æ®

```python
# AI è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ç¤ºä¾‹
print("=== é—¨åº—æ•°æ®å¯¹æ¯” ===")
for i, df in enumerate([df1, df2, df3], 1):
    print(f"\né—¨åº— {i}:")
    print(f"  æ€»é”€å”®é¢: {df['sales'].sum():.2f}")
    print(f"  å¹³å‡å•ä»·: {df['price'].mean():.2f}")
    print(f"  è®¢å•æ•°: {len(df)}")

# ç»˜åˆ¶å¯¹æ¯”å›¾
fig, ax = plt.subplots(figsize=(10, 6))
sales_data = [df1['sales'].sum(), df2['sales'].sum(), df3['sales'].sum()]
ax.bar(['é—¨åº—1', 'é—¨åº—2', 'é—¨åº—3'], sales_data)
ax.set_title('å„é—¨åº—é”€å”®é¢å¯¹æ¯”')
plt.tight_layout()

buf = io.BytesIO()
plt.savefig(buf, format='png')
buf.seek(0)
plt.close()
display(Image(buf.getvalue()))
```

### åœºæ™¯2ï¼šæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

```python
# AI è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ç¤ºä¾‹
print("=== æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ ===")

# å­—æ®µå¯¹æ¯”
common_cols = set(df1.columns) & set(df2.columns) & set(df3.columns)
print(f"\nå…±åŒå­—æ®µ: {common_cols}")

# æ•°æ®ç±»å‹ä¸€è‡´æ€§
for col in common_cols:
    types = [df1[col].dtype, df2[col].dtype, df3[col].dtype]
    if len(set(map(str, types))) > 1:
        print(f"âš ï¸ å­—æ®µ '{col}' ç±»å‹ä¸ä¸€è‡´: {types}")
    else:
        print(f"âœ… å­—æ®µ '{col}' ç±»å‹ä¸€è‡´: {types[0]}")

# å–å€¼èŒƒå›´å¯¹æ¯”
for col in ['score', 'price']:
    if col in common_cols:
        print(f"\nå­—æ®µ '{col}' å–å€¼èŒƒå›´:")
        print(f"  df1: [{df1[col].min()}, {df1[col].max()}]")
        print(f"  df2: [{df2[col].min()}, {df2[col].max()}]")
        print(f"  df3: [{df3[col].min()}, {df3[col].max()}]")
```

---

## ğŸ” API æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•å¤šæ–‡ä»¶ä¸Šä¼ 
```bash
curl -X POST http://localhost:8000/api/upload-multiple \
  -F "files=@file1.csv" \
  -F "files=@file2.csv" \
  -F "files=@file3.csv"
```

### æµ‹è¯•å¤šæ–‡ä»¶Sessionåˆ›å»º
```bash
curl -X POST http://localhost:8000/api/session/create-multi \
  -H "Content-Type: application/json" \
  -d '{
    "group_id": "xxx",
    "tables": [
      {"file_id": "file1", "sheet_name": "Sheet1", "alias": "df1"},
      {"file_id": "file2", "sheet_name": "Sheet1", "alias": "df2"}
    ],
    "selected_columns": []
  }'
```

---

## ğŸ’¡ åç»­ä¼˜åŒ–å»ºè®®

1. **å­—æ®µè‡ªåŠ¨æ˜ å°„**ï¼šAIè‡ªåŠ¨è¯†åˆ«ä¸åŒè¡¨æ ¼ä¸­ç›¸åŒå«ä¹‰çš„å­—æ®µï¼ˆå¦‚ "name" å’Œ "å§“å"ï¼‰
2. **æ™ºèƒ½æ¨èåˆ†æ**ï¼šæ ¹æ®è¡¨æ ¼ç»“æ„è‡ªåŠ¨æ¨èåˆ†æç±»å‹
3. **æ‰¹é‡ä¸‹è½½**ï¼šæ”¯æŒä¸€é”®å¯¼å‡ºæ‰€æœ‰åˆ†æç»“æœå’Œå›¾è¡¨
4. **å†å²å¯¹æ¯”**ï¼šä¿å­˜å¤šæ¬¡åˆ†æç»“æœï¼Œæ”¯æŒè·¨æ—¶é—´å¯¹æ¯”
5. **è‡ªå®šä¹‰alias**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰DataFrameåç§°ï¼ˆå¦‚ df_store1, df_store2ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šæ¯ä¸ªæ–‡ä»¶æœ€å¤§ 100MBï¼ˆå¯åœ¨ `backend/config.py` ä¿®æ”¹ï¼‰
2. **æ–‡ä»¶æ•°é‡é™åˆ¶**ï¼šæœ€å¤šåŒæ—¶ä¸Šä¼  10 ä¸ªæ–‡ä»¶
3. **å†…å­˜å ç”¨**ï¼šå¤šæ–‡ä»¶åˆ†æä¼šå ç”¨æ›´å¤šJupyter Kernelå†…å­˜
4. **Sessionç®¡ç†**ï¼šå»ºè®®åˆ†æå®ŒæˆååŠæ—¶å…³é—­Sessioné‡Šæ”¾èµ„æº
5. **å‘åå…¼å®¹**ï¼šå•æ–‡ä»¶ä¸Šä¼ å’Œåˆ†ææµç¨‹å®Œå…¨ä¿æŒå…¼å®¹

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### åç«¯
- `backend/api/upload.py` - ä¸Šä¼ æ¥å£
- `backend/api/session.py` - Sessionç®¡ç†
- `backend/core/jupyter_manager.py` - Jupyterç®¡ç†
- `backend/core/prompts.py` - AI Prompt
- `backend/core/cache.py` - ç¼“å­˜ç®¡ç†

### å‰ç«¯
- `frontend/src/store/useAppStore.js` - çŠ¶æ€ç®¡ç†
- `frontend/src/components/FileUpload/FileUpload.jsx` - æ–‡ä»¶ä¸Šä¼ ï¼ˆå¾…å®Œå–„ï¼‰
- `frontend/src/components/DataPreview/DataPreview.jsx` - æ•°æ®é¢„è§ˆï¼ˆå¾…å®Œå–„ï¼‰
- `frontend/src/components/ChatArea/ChatArea.jsx` - åˆ†æäº¤äº’ï¼ˆå¾…å®Œå–„ï¼‰

---

**å¼€å‘è¿›åº¦**ï¼š
- âœ… åç«¯å®Œæˆ
- âœ… Storeå®Œæˆ
- â³ å‰ç«¯ç»„ä»¶å¼€å‘ä¸­...

