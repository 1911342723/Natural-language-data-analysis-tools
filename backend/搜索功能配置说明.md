# 搜索功能配置说明

## 重要更新 (2025-11-06)

**搜索功能已改用 OpenAI 兼容 API！**

根据阿里云百炼官方文档，联网搜索不是通过 MCP SSE 端点调用的，而是：
- 使用 **OpenAI 兼容 API**
- 在模型调用时传入 `extra_body={"enable_search": True}`
- 模型自动判断是否需要搜索并返回结果

## 配置步骤

### 1. 检查 API Key

打开 `backend/config.py`，确认以下配置：

```python
# MCP 工具配置
dashscope_api_key: str = Field(
    default="sk-3192c3d6a72846b2b15661628641ad25",  # 阿里百炼API Key
    alias="DASHSCOPE_API_KEY"
)
```

**注意**：`dashscope_base_url` 现在由客户端自动设置为 `https://dashscope.aliyuncs.com/compatible-mode/v1`

### 2. 测试搜索功能

运行测试脚本：

```bash
cd backend
python test_search.py
```

查看输出，检查是否有模拟数据（Mock）：

- ✅ **无模拟数据** → 搜索功能正常
- ⚠️ **有模拟数据** → 继续排查

### 3. 常见问题排查

#### 问题1：API Key 无效

**症状**：
```
❌ Arxiv搜索失败: HTTP 401
   错误内容: Unauthorized
```

**解决**：
1. 检查 API Key 是否正确
2. 确认 API Key 有效期
3. 确认 API Key 权限（需要支持 WebSearch 和 Arxiv 搜索）

#### 问题2：网络连接问题

**症状**：
```
Arxiv搜索失败: Cannot connect to host
```

**解决**：
1. 检查网络连接
2. 确认能访问 `https://dashscope.aliyuncs.com`
3. 检查防火墙/代理设置

#### 问题3：查询无结果

**症状**：
```
⚠️ 未找到论文，返回模拟数据（可能是API配置问题或查询无结果）
```

**解决**：
- 这可能是正常的（某些查询确实没有结果）
- 尝试更通用的查询词，如 "machine learning"

### 4. 环境变量配置（可选）

如果不想修改 `config.py`，可以设置环境变量：

**Windows (PowerShell)**:
```powershell
$env:DASHSCOPE_API_KEY="your-api-key-here"
```

**Linux/Mac**:
```bash
export DASHSCOPE_API_KEY="your-api-key-here"
```

或创建 `.env` 文件：
```
DASHSCOPE_API_KEY=your-api-key-here
DASHSCOPE_BASE_URL=https://dashscope.aliyuncs.com/api/v1
```

### 5. WebSocket 断开问题

**症状**：
```
⚠️ 没有活跃的WebSocket连接，消息未发送
```

**原因**：
- 这是正常的，研究任务在后台执行时，前端可能已关闭页面
- 消息会被缓存，不影响研究执行

**解决**：
- 保持前端页面打开
- WebSocket 会自动重连

## 调试模式

启用详细日志：

```bash
# 修改 backend/main.py
import logging
logging.basicConfig(level=logging.DEBUG)
```

这会显示更多诊断信息，包括：
- API 请求详情
- SSE 数据流
- WebSocket 状态

## 完整测试流程

1. **启动后端**:
   ```bash
   cd backend
   python main.py
   ```

2. **测试搜索**:
   ```bash
   python test_search.py
   ```

3. **启动前端**:
   ```bash
   cd frontend
   npm run dev
   ```

4. **测试完整流程**:
   - 打开 `http://localhost:5173`
   - 点击"科学家团队"
   - 输入课题，如 "机器学习在医疗领域的应用"
   - 观察AI决策和搜索结果

## 预期输出

**正常情况**:
```
✅ 阿里百炼MCP客户端初始化完成: https://dashscope.aliyuncs.com/api/v1
📡 正在读取 Arxiv 搜索结果...
✅ 找到 5 篇论文
```

**配置问题**:
```
⚠️ 阿里百炼 API Key 未配置，搜索功能可能返回模拟数据
❌ Arxiv搜索失败: HTTP 401
⚠️ 未找到论文，返回模拟数据
```

## 获取 API Key

如果需要新的 API Key：

1. 访问 [阿里云百炼平台](https://dashscope.console.aliyun.com/)
2. 注册/登录
3. 创建 API Key
4. 确保开通以下服务：
   - WebSearch MCP
   - Arxiv Paper Assistant MCP

## 联系支持

如果问题仍未解决：

1. 收集完整日志
2. 检查 API Key 权限
3. 确认网络连接正常
4. 联系阿里云技术支持

---

更新时间：2025-11-05

