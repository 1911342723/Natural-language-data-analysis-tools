# ğŸ”¥ å‰ç«¯æµå¼æ¸²æŸ“ä¿®å¤å®Œæˆ

## é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šåç«¯åœ¨æµå¼è¾“å‡ºçš„æ—¶å€™ï¼Œå‰ç«¯è¿˜å¡ç€ä¸åŠ¨ï¼Œåç«¯è¾“å‡ºå®Œæˆäº†ï¼Œå‰ç«¯æ‰å…¨éƒ¨å±•ç¤ºå‡ºæ¥ã€‚

**åŸå› åˆ†æ**ï¼š

åœ¨åŸæœ‰çš„å®ç°ä¸­ï¼ŒAgent çš„æ­¥éª¤å¯¹è±¡ï¼ˆ`AgentStep`ï¼‰æ˜¯åœ¨æ–¹æ³•å†…éƒ¨åˆ›å»ºçš„ï¼Œå¹¶åœ¨æ–¹æ³•æ‰§è¡Œå®Œæˆåæ‰æ·»åŠ åˆ° `self.steps` åˆ—è¡¨ä¸­ï¼š

```python
# âŒ åŸæ¥çš„é—®é¢˜ä»£ç 
async def run(self):
    # æ­¥éª¤1ï¼šç”Ÿæˆä»£ç 
    step1 = await self._generate_code()  # â† åœ¨è¿™é‡Œæ‰§è¡Œæµå¼ç”Ÿæˆ
    self.steps.append(step1)  # â† ä½†åªæœ‰æ‰§è¡Œå®Œæ‰æ·»åŠ åˆ°åˆ—è¡¨ï¼
```

è¿™å¯¼è‡´çš„é—®é¢˜æ˜¯ï¼š
1. åœ¨ AI æµå¼ç”Ÿæˆä»£ç çš„æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ­¥éª¤å¯¹è±¡è¿˜ä¸åœ¨ `self.steps` åˆ—è¡¨ä¸­
2. SSE è½®è¯¢è°ƒç”¨ `agent.get_state()` æ—¶ï¼Œè·å–ä¸åˆ°æ­£åœ¨æ‰§è¡Œçš„æ­¥éª¤
3. å‰ç«¯æ”¶ä¸åˆ°ä»»ä½•æ›´æ–°ï¼Œåªèƒ½ç­‰åˆ°æ•´ä¸ªæ­¥éª¤æ‰§è¡Œå®Œæˆåæ‰èƒ½çœ‹åˆ°

## ä¿®å¤æ–¹æ¡ˆ

**æ ¸å¿ƒæ€è·¯**ï¼š**å…ˆåˆ›å»ºæ­¥éª¤å¹¶æ·»åŠ åˆ°åˆ—è¡¨ï¼Œå†æ‰§è¡Œ**

ä¿®æ”¹åçš„æµç¨‹ï¼š

```python
# âœ… ä¿®å¤åçš„ä»£ç 
async def run(self):
    # æ­¥éª¤1ï¼šç”Ÿæˆä»£ç 
    # å…ˆåˆ›å»ºæ­¥éª¤å¯¹è±¡å¹¶æ·»åŠ åˆ°åˆ—è¡¨
    step1 = AgentStep(
        title="ç”Ÿæˆä»£ç ",
        description="æ ¹æ®ç”¨æˆ·éœ€æ±‚ç”Ÿæˆ Python åˆ†æä»£ç ",
        status="running"
    )
    self.steps.append(step1)  # â­ å…ˆæ·»åŠ åˆ°åˆ—è¡¨
    
    # å†æ‰§è¡Œä»£ç ç”Ÿæˆï¼ˆä¼šå®æ—¶æ›´æ–° step1 çš„ outputï¼‰
    await self._generate_code_impl(step1)
```

## ä¿®æ”¹å†…å®¹

### 1. ä¿®æ”¹ `run()` æ–¹æ³•

å°†æ‰€æœ‰æ­¥éª¤çš„åˆ›å»ºæå‰åˆ°æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼š

- âœ… `_generate_code()` â†’ å…ˆåˆ›å»º `step1`ï¼Œå†è°ƒç”¨ `_generate_code_impl(step1)`
- âœ… `_execute_code()` â†’ å…ˆåˆ›å»º `step2`ï¼Œå†è°ƒç”¨ `_execute_code_impl(step2, code)`
- âœ… `_extract_result()` â†’ å…ˆåˆ›å»º `step3`ï¼Œå†è°ƒç”¨ `_extract_result_impl(step3, ...)`
- âœ… `_generate_summary()` â†’ å…ˆåˆ›å»º `step4`ï¼Œå†è°ƒç”¨ `_generate_summary_impl(step4)`
- âœ… `_fix_code()` â†’ å…ˆåˆ›å»º `step3`ï¼Œå†è°ƒç”¨ `_fix_code_impl(step3, ...)`

### 2. é‡å‘½åæ–¹æ³•

å°†åŸæ¥çš„ç§æœ‰æ–¹æ³•é‡å‘½åä¸º `_xxx_impl()` å½¢å¼ï¼Œå¹¶ä¿®æ”¹ç­¾åï¼š

```python
# åŸæ¥ï¼šè¿”å› AgentStep
async def _generate_code(self) -> AgentStep:
    step = AgentStep(...)
    # æ‰§è¡Œé€»è¾‘
    return step

# ä¿®æ”¹åï¼šæ¥æ”¶ step å‚æ•°ï¼Œç›´æ¥ä¿®æ”¹å®ƒ
async def _generate_code_impl(self, step: AgentStep):
    # step å·²ç»åœ¨å¤–éƒ¨åˆ›å»ºå¹¶æ·»åŠ åˆ° self.steps
    # æ‰§è¡Œé€»è¾‘ï¼Œç›´æ¥ä¿®æ”¹ step çš„å±æ€§
    step.output = "..."
    step.status = "success"
    # ä¸è¿”å›ï¼Œå› ä¸ºå·²ç»åœ¨åˆ—è¡¨ä¸­äº†
```

ä¿®æ”¹çš„æ–¹æ³•ï¼š
- `_generate_code()` â†’ `_generate_code_impl(step)`
- `_execute_code(code)` â†’ `_execute_code_impl(step, code)`
- `_fix_code(...)` â†’ `_fix_code_impl(step, ...)`
- `_extract_result(...)` â†’ `_extract_result_impl(step, ...)`
- `_generate_summary()` â†’ `_generate_summary_impl(step)`

### 3. æµå¼æ›´æ–°æµç¨‹

ç°åœ¨çš„å®Œæ•´æµç¨‹ï¼š

```
åç«¯ Agentï¼š
1. åˆ›å»º step1 â†’ æ·»åŠ åˆ° self.steps â†’ å¼€å§‹æ‰§è¡Œ
2. åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå®æ—¶æ›´æ–° step1.output
   step1.output = "ğŸ”„ AI æ­£åœ¨ç”Ÿæˆä»£ç ...\n\n<å®æ—¶å†…å®¹>"
3. æ¯æ›´æ–°ä¸€æ¬¡ï¼Œawait asyncio.sleep(0.05) è®©å‡ºæ§åˆ¶æƒ

SSE è½®è¯¢ï¼ˆæ¯ 30msï¼‰ï¼š
1. è°ƒç”¨ agent.get_state()
2. éå† self.stepsï¼Œæ£€æŸ¥æ¯ä¸ªæ­¥éª¤çš„ output æ˜¯å¦å˜åŒ–
3. å¦‚æœæœ‰å˜åŒ–ï¼Œç«‹å³æ¨é€ç»™å‰ç«¯
4. yield f"data: {step_event}\n\n"

å‰ç«¯ï¼š
1. æ”¶åˆ° SSE äº‹ä»¶ {"event": "step", "data": {...}}
2. è°ƒç”¨ onStep(step, stepIndex) å›è°ƒ
3. æ›´æ–° Zustand store ä¸­çš„ agentSteps
4. React ç»„ä»¶è‡ªåŠ¨é‡æ–°æ¸²æŸ“
5. ç”¨æˆ·çœ‹åˆ°å®æ—¶æ›´æ–°çš„å†…å®¹ âœ¨
```

## æ•ˆæœ

ä¿®å¤åçš„æ•ˆæœï¼š

### Beforeï¼ˆä¿®å¤å‰ï¼‰âŒ
- å‰ç«¯å¡ç€ä¸åŠ¨
- çœ‹ä¸åˆ° AI ç”Ÿæˆè¿‡ç¨‹
- ç­‰å¾…å¾ˆä¹…åçªç„¶å…¨éƒ¨å‡ºç°
- ç”¨æˆ·ä½“éªŒå·®

### Afterï¼ˆä¿®å¤åï¼‰âœ…
- å‰ç«¯å®æ—¶æ›´æ–°
- çœ‹åˆ° AI åƒ"æ‰“å­—"ä¸€æ ·é€å­—ç”Ÿæˆä»£ç 
- æ¯ä¸ªæ­¥éª¤çš„è¿›åº¦éƒ½èƒ½å®æ—¶çœ‹åˆ°
- ç”¨æˆ·ä½“éªŒæä½³ï¼

## æµ‹è¯•å»ºè®®

1. **å¯åŠ¨åç«¯**ï¼š
```bash
cd backend
python main.py
```

2. **å¯åŠ¨å‰ç«¯**ï¼š
```bash
cd frontend
npm run dev
```

3. **æµ‹è¯•æµç¨‹**ï¼š
   - ä¸Šä¼ æ•°æ®æ–‡ä»¶
   - é€‰æ‹©å­—æ®µ
   - è¾“å…¥åˆ†æéœ€æ±‚
   - è§‚å¯Ÿå‰ç«¯å®æ—¶æ¸²æŸ“æ•ˆæœ
   - åº”è¯¥èƒ½çœ‹åˆ°ï¼š
     - "ğŸ”„ AI æ­£åœ¨ç”Ÿæˆä»£ç ..."
     - ä»£ç å†…å®¹ä¸€ç‚¹ç‚¹æ˜¾ç¤º
     - æ¯ä¸ªæ­¥éª¤éƒ½æœ‰å®æ—¶è¿›åº¦

4. **æŸ¥çœ‹åç«¯æ—¥å¿—**ï¼š
```
ğŸ“¤ æ¨é€æ­¥éª¤æ›´æ–° #0: ç”Ÿæˆä»£ç , status=running, output_len=50
ğŸ“¤ æ¨é€æ­¥éª¤æ›´æ–° #0: ç”Ÿæˆä»£ç , status=running, output_len=150
ğŸ“¤ æ¨é€æ­¥éª¤æ›´æ–° #0: ç”Ÿæˆä»£ç , status=running, output_len=300
...
```

## å…³é”®ä»£ç ä½ç½®

- **åç«¯ Agent é€»è¾‘**ï¼š`backend/core/agent.py`
  - `run()` æ–¹æ³•ï¼šç¬¬ 79-172 è¡Œ
  - `_generate_code_impl()` æ–¹æ³•ï¼šç¬¬ 158-250 è¡Œ
  
- **åç«¯ SSE æ¨é€**ï¼š`backend/api/agent.py`
  - `analyze_stream()` æ–¹æ³•ï¼šç¬¬ 230-439 è¡Œ
  - SSE è½®è¯¢é€»è¾‘ï¼šç¬¬ 357-389 è¡Œ
  
- **å‰ç«¯ SSE æ¥æ”¶**ï¼š`frontend/src/services/api.js`
  - `submitAnalysisStream()` å‡½æ•°ï¼šç¬¬ 131-248 è¡Œ
  
- **å‰ç«¯ç»„ä»¶æ›´æ–°**ï¼š`frontend/src/components/ChatArea/ChatArea.jsx`
  - `handleSubmit()` æ–¹æ³•ï¼šç¬¬ 54-220 è¡Œ
  - `onStep` å›è°ƒï¼šç¬¬ 132-158 è¡Œ

## æ€§èƒ½è¯´æ˜

- **SSE è½®è¯¢é¢‘ç‡**ï¼š30msï¼ˆæ¯ç§’çº¦ 33 æ¬¡ï¼‰
- **AI æ›´æ–°é¢‘ç‡**ï¼šæ¯ 2 ä¸ª token æˆ–æ¯ 20 ä¸ªå­—ç¬¦
- **è®©å‡ºæ§åˆ¶æƒé—´éš”**ï¼š50ms
- **å‰ç«¯æ¸²æŸ“ä¼˜åŒ–**ï¼šReact è‡ªåŠ¨æ‰¹å¤„ç†æ›´æ–°

æ•´ä½“æ€§èƒ½ä¼˜ç§€ï¼Œä¸ä¼šé€ æˆå¡é¡¿ï¼

## æ€»ç»“

é€šè¿‡**æå‰åˆ›å»ºæ­¥éª¤å¯¹è±¡å¹¶æ·»åŠ åˆ°åˆ—è¡¨**ï¼Œä½¿å¾— SSE è½®è¯¢èƒ½å¤Ÿå®æ—¶è·å–åˆ°æ­¥éª¤çš„çŠ¶æ€å˜åŒ–ï¼Œä»è€Œå®ç°äº†çœŸæ­£çš„æµå¼æ¸²æŸ“æ•ˆæœï¼

ç°åœ¨ç”¨æˆ·å¯ä»¥ï¼š
- âœ… å®æ—¶çœ‹åˆ° AI ç”Ÿæˆä»£ç çš„è¿‡ç¨‹
- âœ… å®æ—¶çœ‹åˆ°ä»£ç æ‰§è¡Œçš„è¾“å‡º
- âœ… å®æ—¶çœ‹åˆ°é”™è¯¯ä¿®å¤çš„è¿‡ç¨‹
- âœ… äº«å—æµç•…çš„äº¤äº’ä½“éªŒï¼

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-11-01  
**ä¿®å¤äºº**ï¼šAI Assistant  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

