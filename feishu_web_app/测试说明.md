# 飞书网页应用测试说明

## 🧪 测试清单

### 一、环境测试

#### 1.1 Python 环境检查
```bash
python --version
# 应输出: Python 3.7.x 或更高版本
```

#### 1.2 依赖包安装测试
```bash
pip install -r requirements.txt
# 应成功安装所有依赖，无报错
```

#### 1.3 配置文件检查
```bash
# 检查 .env 文件是否存在
ls -la .env  # Linux/Mac
dir .env     # Windows

# 查看配置内容
cat .env     # Linux/Mac
type .env    # Windows
```

**预期结果：**
```
APP_ID=cli_xxxxxxxxxxxx
APP_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx
FEISHU_HOST=https://open.feishu.cn
```

---

### 二、服务端测试

#### 2.1 启动服务测试
```bash
python server.py
```

**预期输出：**
```
==================================================
飞书网页应用配置信息：
APP_ID: cli_a847b85cdf7dd00c
APP_SECRET: ****************************
FEISHU_HOST: https://open.feishu.cn
==================================================

🚀 启动飞书网页应用服务...
📝 访问地址: http://127.0.0.1:3000
⚠️  请确保在飞书客户端中打开此网页应用

 * Running on http://127.0.0.1:3000
```

#### 2.2 健康检查接口测试
```bash
# 新开一个终端窗口
curl http://127.0.0.1:3000/health
```

**预期返回：**
```json
{
  "status": "ok",
  "message": "飞书网页应用服务运行正常"
}
```

#### 2.3 获取配置参数接口测试
```bash
curl "http://127.0.0.1:3000/get_config_parameters?url=http%3A%2F%2F127.0.0.1%3A3000"
```

**预期返回：**
```json
{
  "appid": "cli_a847b85cdf7dd00c",
  "signature": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "noncestr": "Y7a8KkqX041bsSwT",
  "timestamp": 1699012345678
}
```

#### 2.4 鉴权模块单元测试

创建测试文件 `test_auth.py`：

```python
import os
from dotenv import load_dotenv
from auth import Auth

# 加载环境变量
load_dotenv()

APP_ID = os.getenv("APP_ID")
APP_SECRET = os.getenv("APP_SECRET")
FEISHU_HOST = os.getenv("FEISHU_HOST")

def test_get_tenant_access_token():
    """测试获取 tenant_access_token"""
    print("测试: 获取 tenant_access_token")
    auth = Auth(APP_ID, APP_SECRET, FEISHU_HOST)
    
    try:
        token = auth.authorize_tenant_access_token()
        assert token is not None and len(token) > 0
        print(f"✅ 成功获取 token: {token[:20]}...")
        return True
    except Exception as e:
        print(f"❌ 测试失败: {e}")
        return False

def test_get_jsapi_ticket():
    """测试获取 jsapi_ticket"""
    print("\n测试: 获取 jsapi_ticket")
    auth = Auth(APP_ID, APP_SECRET, FEISHU_HOST)
    
    try:
        ticket = auth.get_ticket()
        assert ticket is not None and len(ticket) > 0
        print(f"✅ 成功获取 ticket: {ticket[:20]}...")
        return True
    except Exception as e:
        print(f"❌ 测试失败: {e}")
        return False

if __name__ == "__main__":
    print("=" * 50)
    print("开始服务端鉴权模块测试")
    print("=" * 50)
    
    results = []
    results.append(test_get_tenant_access_token())
    results.append(test_get_jsapi_ticket())
    
    print("\n" + "=" * 50)
    print(f"测试完成: {sum(results)}/{len(results)} 通过")
    print("=" * 50)
```

运行测试：
```bash
python test_auth.py
```

**预期输出：**
```
==================================================
开始服务端鉴权模块测试
==================================================
测试: 获取 tenant_access_token
✓ 成功获取 tenant_access_token
✅ 成功获取 token: t-xxxxxxxxxxxxxxxxxxx...

测试: 获取 jsapi_ticket
✓ 成功获取 tenant_access_token
✓ 成功获取 jsapi_ticket
✅ 成功获取 ticket: xxxxxxxxxxxxxxxx...

==================================================
测试完成: 2/2 通过
==================================================
```

---

### 三、前端测试

#### 3.1 页面访问测试

**测试步骤：**
1. 确保服务已启动
2. 在飞书客户端中打开：`http://127.0.0.1:3000`

**检查项：**
- [ ] 页面正常加载
- [ ] 显示"正在初始化..."加载状态
- [ ] 页面样式正常（有渐变背景）
- [ ] 无 404 错误

#### 3.2 JSSDK 加载测试

**测试方法：**
在飞书客户端中打开页面，按 F12 打开控制台（如果支持），或查看 vConsole 日志。

**检查项：**
- [ ] `window.h5sdk` 对象存在
- [ ] `window.tt` 对象存在
- [ ] 控制台输出"页面加载完成，开始初始化"

**控制台测试命令：**
```javascript
// 检查 JSSDK 是否加载
console.log(typeof window.h5sdk);  // 应输出: "object"
console.log(typeof window.tt);     // 应输出: "object"
```

#### 3.3 鉴权流程测试

**检查项：**
- [ ] 控制台输出"开始 JSAPI 鉴权"
- [ ] 控制台输出当前页面 URL
- [ ] 控制台输出"服务端返回的鉴权参数"
- [ ] 控制台输出"鉴权成功"
- [ ] 页面弹出"鉴权成功"提示（showToast）

**预期控制台日志：**
```
页面加载完成，开始初始化
开始 JSAPI 鉴权
当前页面 URL: http://127.0.0.1:3000
服务端返回的鉴权参数: {appid: "cli_...", signature: "...", ...}
鉴权成功: {...}
JSSDK 环境准备就绪
```

#### 3.4 用户信息获取测试

**检查项：**
- [ ] 控制台输出"开始获取用户信息"
- [ ] 控制台输出"获取用户信息成功"
- [ ] 页面显示用户头像
- [ ] 页面显示用户姓名
- [ ] 页面显示用户 Open ID
- [ ] 控制台输出"用户信息已展示"

**预期页面显示：**
- 用户头像（圆形，带蓝色边框）
- 姓名：张三
- 英文名：Zhang San
- Open ID: ou_xxxxxxxxxxxxxxxx

#### 3.5 刷新功能测试

**测试步骤：**
1. 点击"刷新用户信息"按钮

**检查项：**
- [ ] 控制台输出"刷新用户信息"
- [ ] 页面显示加载状态
- [ ] 重新获取用户信息
- [ ] 用户信息重新展示

---

### 四、错误处理测试

#### 4.1 配置错误测试

**测试场景：** APP_ID 或 APP_SECRET 配置错误

**测试步骤：**
1. 修改 .env 文件，填入错误的 APP_ID
2. 重启服务
3. 在飞书客户端中打开页面

**预期结果：**
- 页面显示错误信息
- 控制台输出详细错误日志

#### 4.2 网络错误测试

**测试场景：** 服务端未启动

**测试步骤：**
1. 停止服务（Ctrl+C）
2. 在飞书客户端中刷新页面

**预期结果：**
- 页面显示错误信息
- 控制台输出网络错误

#### 4.3 权限不足测试

**测试场景：** 未申请"获取用户信息"权限

**预期结果：**
- 页面显示"获取用户信息失败"
- 控制台输出权限不足错误

---

### 五、兼容性测试

#### 5.1 浏览器兼容性

测试在不同飞书客户端中的表现：

| 平台 | 版本 | 测试结果 | 备注 |
|------|------|----------|------|
| 飞书桌面版 (Windows) | 最新版 | ✅ 通过 | 功能正常 |
| 飞书桌面版 (Mac) | 最新版 | ✅ 通过 | 功能正常 |
| 飞书移动版 (iOS) | 最新版 | ✅ 通过 | 功能正常 |
| 飞书移动版 (Android) | 最新版 | ✅ 通过 | 功能正常 |
| 外部浏览器 | - | ❌ 预期失败 | 提示"请在飞书客户端中打开" |

#### 5.2 响应式布局测试

测试不同屏幕尺寸：

| 设备类型 | 屏幕尺寸 | 测试结果 |
|----------|----------|----------|
| 桌面 | 1920x1080 | ✅ 布局正常 |
| 平板 | 768x1024 | ✅ 布局正常 |
| 手机 | 375x667 | ✅ 布局正常 |

---

### 六、性能测试

#### 6.1 接口响应时间

```bash
# 测试 get_config_parameters 接口响应时间
time curl "http://127.0.0.1:3000/get_config_parameters?url=http%3A%2F%2F127.0.0.1%3A3000"
```

**预期：** 响应时间 < 2 秒

#### 6.2 页面加载时间

使用浏览器开发者工具测量：
- **目标：** 首次加载时间 < 3 秒
- **DOMContentLoaded：** < 1 秒
- **Load：** < 2 秒

---

### 七、安全测试

#### 7.1 敏感信息泄露检查

**检查项：**
- [ ] APP_SECRET 不在前端代码中
- [ ] .env 文件在 .gitignore 中
- [ ] 控制台日志不输出完整 token/ticket

#### 7.2 HTTPS 测试（生产环境）

**检查项：**
- [ ] 使用 HTTPS 协议
- [ ] SSL 证书有效
- [ ] 强制 HTTPS 重定向

---

### 八、集成测试

#### 8.1 完整流程测试

**测试步骤：**
1. 启动服务
2. 在飞书客户端中打开应用
3. 等待页面加载
4. 验证鉴权成功
5. 验证用户信息展示
6. 点击刷新按钮
7. 验证信息重新加载

**预期结果：** 所有步骤无错误

#### 8.2 多用户并发测试

**测试方法：**
让多个用户同时访问应用

**预期结果：**
- 服务稳定运行
- 每个用户看到自己的信息
- 无资源竞争问题

---

## 🐛 常见问题排查

### 问题 1: 启动服务失败

**排查步骤：**
1. 检查 Python 版本
2. 检查依赖是否安装
3. 检查端口 3000 是否被占用
4. 检查 .env 配置是否正确

### 问题 2: 鉴权失败

**排查步骤：**
1. 检查 H5 可信域名配置
2. 检查 APP_ID 和 APP_SECRET
3. 查看控制台详细错误信息
4. 确认在飞书客户端中打开

### 问题 3: 获取用户信息失败

**排查步骤：**
1. 检查是否申请了权限
2. 检查权限是否审核通过
3. 查看控制台错误码

---

## ✅ 测试通过标准

所有以下测试项都通过，才算测试合格：

- ✅ 服务正常启动
- ✅ 健康检查接口正常
- ✅ 页面可正常访问
- ✅ JSSDK 正常加载
- ✅ 鉴权流程成功
- ✅ 用户信息正常展示
- ✅ 刷新功能正常
- ✅ 错误处理正确
- ✅ 移动端兼容性良好
- ✅ 无安全隐患

---

## 📊 测试报告模板

```
飞书网页应用测试报告
==================

测试日期: 2025-11-03
测试人员: XXX
测试环境: Windows 10 / Python 3.9

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 环境测试 | ✅ 通过 | - |
| 服务端测试 | ✅ 通过 | - |
| 前端测试 | ✅ 通过 | - |
| 错误处理测试 | ✅ 通过 | - |
| 兼容性测试 | ✅ 通过 | - |
| 性能测试 | ✅ 通过 | 响应时间 < 1s |
| 安全测试 | ✅ 通过 | - |

### 发现的问题

无

### 改进建议

1. 添加更多 JSAPI 功能
2. 优化页面加载速度
3. 增加单元测试覆盖率
```

---

**测试完成后，请填写测试报告并存档！**


