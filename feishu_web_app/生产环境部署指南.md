# ğŸš€ é£ä¹¦ç½‘é¡µåº”ç”¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ç›®å½•
1. [éƒ¨ç½²å‡†å¤‡](#éƒ¨ç½²å‡†å¤‡)
2. [æœåŠ¡å™¨é…ç½®](#æœåŠ¡å™¨é…ç½®)
3. [åŸŸåå’ŒSSLé…ç½®](#åŸŸåå’Œsslé…ç½®)
4. [é£ä¹¦åå°é…ç½®](#é£ä¹¦åå°é…ç½®)
5. [åº”ç”¨éƒ¨ç½²](#åº”ç”¨éƒ¨ç½²)
6. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
7. [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## éƒ¨ç½²å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

**æ¨èé…ç½®ï¼š**
- **CPU**: 2æ ¸ä»¥ä¸Š
- **å†…å­˜**: 4GBä»¥ä¸Š
- **ç¡¬ç›˜**: 20GBä»¥ä¸Š
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04/22.04 æˆ– CentOS 7/8
- **ç½‘ç»œ**: å…¬ç½‘IPï¼Œè‡³å°‘5Mbpså¸¦å®½

**è½¯ä»¶è¦æ±‚ï¼š**
- Python 3.7+
- Nginx
- Git
- å¯é€‰ï¼šRedisï¼ˆç”¨äº session å­˜å‚¨ï¼‰
- å¯é€‰ï¼šSupervisorï¼ˆè¿›ç¨‹å®ˆæŠ¤ï¼‰

### 2. åŸŸåå‡†å¤‡

éœ€è¦ä¸€ä¸ªå·²å¤‡æ¡ˆçš„åŸŸåï¼ˆå›½å†…æœåŠ¡å™¨ï¼‰æˆ–æµ·å¤–æœåŠ¡å™¨æ— éœ€å¤‡æ¡ˆã€‚

ç¤ºä¾‹ï¼š`app.your-domain.com`

---

## æœåŠ¡å™¨é…ç½®

### 1. è¿æ¥æœåŠ¡å™¨

```bash
ssh user@your-server-ip
```

### 2. æ›´æ–°ç³»ç»Ÿ

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 3. å®‰è£…åŸºç¡€è½¯ä»¶

```bash
# Ubuntu/Debian
sudo apt install -y python3 python3-pip python3-venv nginx git supervisor redis-server

# CentOS/RHEL
sudo yum install -y python3 python3-pip nginx git supervisor redis
```

### 4. åˆ›å»ºéƒ¨ç½²ç›®å½•

```bash
sudo mkdir -p /var/www/feishu-app
sudo chown $USER:$USER /var/www/feishu-app
cd /var/www/feishu-app
```

---

## åŸŸåå’ŒSSLé…ç½®

### 1. é…ç½®DNSè§£æ

åœ¨åŸŸåæœåŠ¡å•†å¤„æ·»åŠ  A è®°å½•ï¼š
```
app.your-domain.com  â†’  æ‚¨çš„æœåŠ¡å™¨IP
```

### 2. å®‰è£…SSLè¯ä¹¦ï¼ˆLet's Encryptï¼‰

```bash
# å®‰è£… certbot
sudo apt install -y certbot python3-certbot-nginx  # Ubuntu
sudo yum install -y certbot python3-certbot-nginx  # CentOS

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d app.your-domain.com

# æŒ‰æç¤ºè¾“å…¥é‚®ç®±å¹¶åŒæ„æ¡æ¬¾
```

### 3. è‡ªåŠ¨ç»­æœŸ

```bash
# æ·»åŠ è‡ªåŠ¨ç»­æœŸä»»åŠ¡
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥ç»­æœŸï¼‰
0 2 * * * certbot renew --quiet
```

---

## é£ä¹¦åå°é…ç½®

### 1. ç™»å½•é£ä¹¦å¼€å‘è€…åå°

è®¿é—®ï¼šhttps://open.feishu.cn/app

### 2. ä¿®æ”¹åº”ç”¨é…ç½®

#### â‘  ç½‘é¡µåº”ç”¨ä¸»é¡µ
- è·¯å¾„ï¼šåº”ç”¨èƒ½åŠ› â†’ ç½‘é¡µåº”ç”¨
- æ¡Œé¢ç«¯ä¸»é¡µï¼š`https://app.your-domain.com`
- ç§»åŠ¨ç«¯ä¸»é¡µï¼š`https://app.your-domain.com`

#### â‘¡ H5 å¯ä¿¡åŸŸå
- è·¯å¾„ï¼šå®‰å…¨è®¾ç½® â†’ H5 å¯ä¿¡åŸŸå
- æ·»åŠ ï¼š`app.your-domain.com`

#### â‘¢ é‡å®šå‘ URL
- è·¯å¾„ï¼šå®‰å…¨è®¾ç½® â†’ é‡å®šå‘ URL
- **é‡è¦**ï¼šé…ç½®å‰ç«¯é¡µé¢åœ°å€ï¼Œä¸æ˜¯åç«¯APIåœ°å€
- å¼€å‘ç¯å¢ƒæ·»åŠ ï¼š`http://127.0.0.1:3000`
- ç”Ÿäº§ç¯å¢ƒæ·»åŠ ï¼š`https://app.your-domain.com`
- **è¯´æ˜**ï¼šè™½ç„¶æˆ‘ä»¬ä½¿ç”¨ JSAPI æ–¹å¼ä¸æ¶‰åŠé¡µé¢è·³è½¬ï¼Œä½†é£ä¹¦ä¼šæ ¡éªŒè°ƒç”¨ `tt.requestAuthCode()` çš„é¡µé¢åœ°å€æ˜¯å¦åœ¨é‡å®šå‘ URL ç™½åå•ä¸­

#### â‘£ ç”³è¯·æƒé™
- è·¯å¾„ï¼šæƒé™ç®¡ç†
- ç”³è¯·ä»¥ä¸‹æƒé™ï¼š
  - âœ… è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆ`contact:user.base:readonly`ï¼‰
  - âœ… è·å–ç”¨æˆ·é‚®ç®±ï¼ˆ`contact:user.email:readonly`ï¼‰
  - âœ… è·å–ç”¨æˆ·æ‰‹æœºå·ï¼ˆ`contact:user.phone:readonly`ï¼‰

#### â‘¤ IPç™½åå•ï¼ˆå¯é€‰ï¼‰
- è·¯å¾„ï¼šå®‰å…¨è®¾ç½® â†’ IP ç™½åå•
- å¦‚æœå¼€å¯ï¼Œæ·»åŠ æœåŠ¡å™¨å…¬ç½‘IP

### 3. å‘å¸ƒåº”ç”¨

- è·¯å¾„ï¼šç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒ
- åˆ›å»ºæ–°ç‰ˆæœ¬
- å¡«å†™ç‰ˆæœ¬è¯´æ˜
- æäº¤å®¡æ ¸
- å®¡æ ¸é€šè¿‡åå‘å¸ƒä¸Šçº¿

---

## åº”ç”¨éƒ¨ç½²

### 1. å…‹éš†ä»£ç 

```bash
cd /var/www/feishu-app
git clone <ä½ çš„ä»£ç ä»“åº“åœ°å€> .

# æˆ–è€…ç›´æ¥ä¸Šä¼ ä»£ç 
scp -r feishu_web_app/* user@server:/var/www/feishu-app/
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# åˆ›å»º .env æ–‡ä»¶
cat > .env << 'EOF'
APP_ID=cli_xxxxxxxxxxxx
APP_SECRET=your_app_secret_here
FEISHU_HOST=https://open.feishu.cn

# ç”Ÿäº§ç¯å¢ƒé…ç½®
ENV=production
DEBUG=False
SECRET_KEY=ç”Ÿæˆä¸€ä¸ªéšæœºå¯†é’¥
EOF

# ç”Ÿæˆéšæœºå¯†é’¥
python3 -c "import secrets; print(f'SECRET_KEY={secrets.token_hex(32)}')" >> .env
```

### 3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

```bash
python3 -m venv venv
source venv/bin/activate
```

### 4. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt

# é¢å¤–å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–
pip install gunicorn redis flask-redis-session
```

### 5. æµ‹è¯•å¯åŠ¨

```bash
# æµ‹è¯•æœåŠ¡æ˜¯å¦æ­£å¸¸
python server_with_auth.py

# å¦‚æœæ­£å¸¸ï¼ŒæŒ‰ Ctrl+C åœæ­¢
```

---

## Gunicorn é…ç½®

### 1. åˆ›å»º Gunicorn é…ç½®æ–‡ä»¶

```bash
cat > gunicorn_config.py << 'EOF'
import multiprocessing

# ç»‘å®šåœ°å€
bind = "127.0.0.1:8000"

# å·¥ä½œè¿›ç¨‹æ•°ï¼ˆæ¨èï¼šCPUæ ¸å¿ƒæ•° * 2 + 1ï¼‰
workers = multiprocessing.cpu_count() * 2 + 1

# å·¥ä½œæ¨¡å¼
worker_class = "sync"

# æ¯ä¸ªå·¥ä½œè¿›ç¨‹çš„çº¿ç¨‹æ•°
threads = 2

# è¶…æ—¶æ—¶é—´
timeout = 120

# æ—¥å¿—
accesslog = "/var/www/feishu-app/logs/gunicorn-access.log"
errorlog = "/var/www/feishu-app/logs/gunicorn-error.log"
loglevel = "info"

# è¿›ç¨‹åç§°
proc_name = "feishu-app"

# åå°è¿è¡Œ
daemon = False
EOF

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs
```

### 2. æµ‹è¯• Gunicorn

```bash
gunicorn -c gunicorn_config.py server_with_auth:app
```

---

## Nginx é…ç½®

### 1. åˆ›å»º Nginx é…ç½®

```bash
sudo vim /etc/nginx/sites-available/feishu-app
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```nginx
# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name app.your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS é…ç½®
server {
    listen 443 ssl http2;
    server_name app.your-domain.com;

    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/app.your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.your-domain.com/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # æ—¥å¿—
    access_log /var/log/nginx/feishu-app-access.log;
    error_log /var/log/nginx/feishu-app-error.log;
    
    # é™æ€æ–‡ä»¶
    location /public {
        alias /var/www/feishu-app/public;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # API ä»£ç†
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒï¼ˆå¯é€‰ï¼‰
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
    client_max_body_size 100M;
}
```

### 2. å¯ç”¨é…ç½®

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/feishu-app /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

---

## Supervisor é…ç½®

### 1. åˆ›å»º Supervisor é…ç½®

```bash
sudo vim /etc/supervisor/conf.d/feishu-app.conf
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ini
[program:feishu-app]
command=/var/www/feishu-app/venv/bin/gunicorn -c gunicorn_config.py server_with_auth:app
directory=/var/www/feishu-app
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/www/feishu-app/logs/supervisor.log
environment=PATH="/var/www/feishu-app/venv/bin"
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# é‡æ–°åŠ è½½ Supervisor é…ç½®
sudo supervisorctl reread
sudo supervisorctl update

# å¯åŠ¨åº”ç”¨
sudo supervisorctl start feishu-app

# æŸ¥çœ‹çŠ¶æ€
sudo supervisorctl status feishu-app
```

### 3. å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ—¥å¿—
sudo supervisorctl tail feishu-app

# é‡å¯åº”ç”¨
sudo supervisorctl restart feishu-app

# åœæ­¢åº”ç”¨
sudo supervisorctl stop feishu-app
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. Redis Session å­˜å‚¨

ä¿®æ”¹ `server_with_auth.py`ï¼š

```python
from flask_session import Session
import redis

# Redis é…ç½®
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.from_url('redis://localhost:6379/0')
Session(app)
```

### 2. å¯ç”¨ Gzip å‹ç¼©

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ ï¼š

```nginx
# å¯ç”¨ gzip
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript 
           application/x-javascript application/xml+rss 
           application/json application/javascript;
```

### 3. CDN åŠ é€Ÿ

å°†é™æ€èµ„æºï¼ˆJSã€CSSã€å›¾ç‰‡ï¼‰ä¸Šä¼ åˆ° CDNï¼Œä¿®æ”¹å¼•ç”¨è·¯å¾„ã€‚

---

## ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨æ—¥å¿—

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/gunicorn-access.log
tail -f logs/gunicorn-error.log

# æŸ¥çœ‹ Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/feishu-app-access.log
sudo tail -f /var/log/nginx/feishu-app-error.log
```

### 2. æ—¥å¿—è½®è½¬

```bash
sudo vim /etc/logrotate.d/feishu-app
```

æ·»åŠ ï¼š

```
/var/www/feishu-app/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    missingok
    sharedscripts
    postrotate
        sudo supervisorctl restart feishu-app
    endscript
}
```

### 3. ç›‘æ§å‘Šè­¦

æ¨èä½¿ç”¨ï¼š
- **Prometheus + Grafana**ï¼šæ€§èƒ½ç›‘æ§
- **Sentry**ï¼šé”™è¯¯è¿½è¸ª
- **Uptime Robot**ï¼šå¯ç”¨æ€§ç›‘æ§

---

## å®‰å…¨åŠ å›º

### 1. é˜²ç«å¢™é…ç½®

```bash
# å…è®¸å¿…è¦ç«¯å£
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### 2. é™åˆ¶è®¿é—®

åœ¨ Nginx ä¸­æ·»åŠ ï¼š

```nginx
# IP é™æµ
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req zone=api_limit burst=20 nodelay;

# é˜²æ­¢ DDoS
limit_conn_zone $binary_remote_addr zone=addr:10m;
limit_conn addr 10;
```

### 3. å®šæœŸæ›´æ–°

```bash
# åˆ›å»ºè‡ªåŠ¨æ›´æ–°è„šæœ¬
cat > /var/www/feishu-app/update.sh << 'EOF'
#!/bin/bash
cd /var/www/feishu-app
git pull
source venv/bin/activate
pip install -r requirements.txt
sudo supervisorctl restart feishu-app
EOF

chmod +x /var/www/feishu-app/update.sh
```

---

## å¸¸è§é—®é¢˜

### Q1: 502 Bad Gateway

**åŸå› ï¼š** Gunicorn æœªå¯åŠ¨æˆ–ç«¯å£é…ç½®é”™è¯¯

**è§£å†³ï¼š**
```bash
sudo supervisorctl status feishu-app
sudo supervisorctl start feishu-app
```

### Q2: é‰´æƒå¤±è´¥

**åŸå› ï¼š** H5 å¯ä¿¡åŸŸåæœªé…ç½®

**è§£å†³ï¼š** åœ¨é£ä¹¦åå°æ·»åŠ æ­£ç¡®çš„åŸŸå

### Q3: Session ä¸¢å¤±

**åŸå› ï¼š** å¤šè¿›ç¨‹ç¯å¢ƒä¸‹æ–‡ä»¶ session ä¸åŒæ­¥

**è§£å†³ï¼š** ä½¿ç”¨ Redis å­˜å‚¨ session

### Q4: æ€§èƒ½é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
- å¢åŠ  Gunicorn workers æ•°é‡
- ä½¿ç”¨ Redis ç¼“å­˜
- å¯ç”¨ CDN

---

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] æœåŠ¡å™¨é…ç½®å®Œæˆ
- [ ] åŸŸåè§£æç”Ÿæ•ˆ
- [ ] SSL è¯ä¹¦å®‰è£…æˆåŠŸ
- [ ] é£ä¹¦åå°é…ç½®å®Œæˆï¼ˆåŸŸåã€æƒé™ã€å‘å¸ƒï¼‰
- [ ] .env æ–‡ä»¶é…ç½®æ­£ç¡®
- [ ] Gunicorn æ­£å¸¸å¯åŠ¨
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] Supervisor å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ
- [ ] é˜²ç«å¢™é…ç½®å®Œæˆ
- [ ] æ—¥å¿—è½®è½¬é…ç½®å®Œæˆ
- [ ] åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­æµ‹è¯•è®¿é—®æˆåŠŸ
- [ ] å¤šç”¨æˆ·ç™»å½•æµ‹è¯•é€šè¿‡

---

## æŠ€æœ¯æ”¯æŒ

- é£ä¹¦å¼€æ”¾å¹³å°æ–‡æ¡£ï¼šhttps://open.feishu.cn/document/
- é£ä¹¦å¼€å‘è€…ç¤¾åŒºï¼šhttps://open.feishu.cn/community
- Flask æ–‡æ¡£ï¼šhttps://flask.palletsprojects.com/
- Nginx æ–‡æ¡£ï¼šhttps://nginx.org/en/docs/

---

**éƒ¨ç½²å®Œæˆåï¼Œè®°å¾—åœ¨é£ä¹¦å·¥ä½œå°ä¸­æ·»åŠ åº”ç”¨ï¼Œå³å¯åœ¨é£ä¹¦ä¸­ä½¿ç”¨ï¼** ğŸ‰

