# 飞书网页应用项目说明

## 📋 项目概述

这是一个基于 **Flask + JSSDK** 的飞书网页应用完整实现，演示了：
- ✅ 服务端鉴权（获取 access_token 和 jsapi_ticket）
- ✅ 前端 JSAPI 鉴权流程
- ✅ 调用飞书客户端能力（获取用户信息）
- ✅ 美观的用户界面
- ✅ 完整的错误处理

## 📁 项目结构

```
feishu_web_app/
├── README.md                 # 完整开发文档
├── 快速开始.md               # 快速启动指南
├── 项目说明.md               # 本文件
├── .env                      # 环境配置（包含 APP_ID 和 APP_SECRET）
├── .gitignore                # Git 忽略文件配置
├── requirements.txt          # Python 依赖包
├── run.bat                   # Windows 启动脚本
├── run.sh                    # Linux/Mac 启动脚本
│
├── auth.py                   # 服务端鉴权模块
├── server.py                 # 服务端核心代码（Flask 应用）
│
├── templates/                # 前端 HTML 模板
│   └── index.html           # 主页面
│
└── public/                   # 前端静态资源
    ├── index.js             # 前端交互代码
    └── index.css            # 前端样式文件
```

## 🎯 核心功能

### 1. 服务端鉴权（auth.py）

**功能：**
- 获取 `tenant_access_token`
- 获取 `jsapi_ticket`
- 自动处理 token 刷新

**关键代码：**
```python
auth = Auth(APP_ID, APP_SECRET, FEISHU_HOST)
ticket = auth.get_ticket()  # 获取 jsapi_ticket
```

### 2. 签名生成（server.py）

**功能：**
- 生成 JSSDK 鉴权所需的签名
- 返回前端所需的鉴权参数

**签名算法：**
```python
verify_str = f"jsapi_ticket={ticket}&noncestr={NONCE_STR}&timestamp={timestamp}&url={url}"
signature = hashlib.sha1(verify_str.encode("utf-8")).hexdigest()
```

### 3. 前端鉴权（public/index.js）

**流程：**
1. 获取当前页面 URL
2. 向服务端请求鉴权参数
3. 调用 `h5sdk.config` 进行鉴权
4. 在 `h5sdk.ready` 中调用 JSAPI

**示例：**
```javascript
window.h5sdk.config({
  appId: res.appid,
  timestamp: res.timestamp,
  nonceStr: res.noncestr,
  signature: res.signature,
  onSuccess: (res) => console.log('鉴权成功'),
  onFail: (err) => console.error('鉴权失败', err)
});
```

### 4. 用户界面（templates/index.html + public/index.css）

**特点：**
- 🎨 现代化渐变设计
- 📱 响应式布局（支持移动端）
- ✨ 优雅的动画效果
- 🔍 移动端调试支持（vConsole）

## 🚀 使用方法

### 方法一：使用启动脚本（推荐）

**Windows:**
```bash
双击运行 run.bat
```

**Linux/Mac:**
```bash
chmod +x run.sh
./run.sh
```

### 方法二：手动启动

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置 .env 文件
# 编辑 .env，填入真实的 APP_ID 和 APP_SECRET

# 3. 启动服务
python server.py
```

## ⚙️ 配置清单

### 1. 环境配置（.env）
```env
APP_ID=cli_a847b85cdf7dd00c        # 你的应用 ID
APP_SECRET=HA7eo9sFIoRVNoxQQNQobcTHNtgeQzvX  # 你的应用密钥
FEISHU_HOST=https://open.feishu.cn  # 飞书开放平台地址
```

### 2. 飞书开发者后台配置

#### ① 添加网页应用能力
路径：应用详情页 → 应用能力 → 添加应用能力 → 网页应用

#### ② 配置应用主页
路径：应用能力 → 网页应用
- **桌面端主页**: `http://127.0.0.1:3000`

#### ③ 配置 H5 可信域名
路径：安全设置 → H5 可信域名
- 添加：`127.0.0.1:3000`

#### ④ 申请权限（可选）
路径：权限管理
- 申请"获取用户信息"权限（用于获取用户详细信息）

## 🔍 API 接口

### GET /
返回主页面（index.html）

### GET /get_config_parameters
获取 JSAPI 鉴权参数

**请求参数：**
- `url`: 需要鉴权的网页 URL（必填）

**返回数据：**
```json
{
  "appid": "cli_xxxxxxxxxxxx",
  "signature": "40a68999ecf7e05907edba43b31a50fd1830c777",
  "noncestr": "Y7a8KkqX041bsSwT",
  "timestamp": 1510045655000
}
```

### GET /health
健康检查接口

**返回数据：**
```json
{
  "status": "ok",
  "message": "飞书网页应用服务运行正常"
}
```

## 🎨 界面预览

### 加载状态
- 显示加载动画和提示文字

### 成功状态
- 展示用户头像
- 显示用户姓名、英文名
- 显示用户 Open ID
- 提供刷新按钮

### 错误状态
- 显示错误图标
- 展示详细错误信息

## 🐛 调试技巧

### 1. 查看控制台日志
前端已集成 vConsole，在移动端可以查看详细日志

### 2. 常用调试命令
```javascript
// 查看 h5sdk 是否加载
console.log(window.h5sdk);

// 查看 tt 对象
console.log(window.tt);

// 查看当前 URL
console.log(location.href.split("#")[0]);
```

### 3. 服务端日志
启动服务后，所有请求和错误都会在控制台输出

## 📊 技术栈

### 后端
- **Flask**: 轻量级 Web 框架
- **requests**: HTTP 请求库
- **python-dotenv**: 环境变量管理

### 前端
- **HTML5**: 页面结构
- **CSS3**: 样式和动画
- **JavaScript (ES6+)**: 交互逻辑
- **jQuery**: DOM 操作
- **飞书 JSSDK**: 客户端能力调用
- **vConsole**: 移动端调试

## 🔐 安全建议

1. **不要将 .env 文件提交到 Git**
   - 已在 .gitignore 中配置

2. **生产环境使用 HTTPS**
   - 配置 SSL 证书
   - 使用 Nginx 反向代理

3. **定期更新依赖包**
   ```bash
   pip list --outdated
   pip install --upgrade package_name
   ```

4. **配置 IP 白名单**
   - 在飞书开发者后台配置
   - 限制 API 调用来源

## 📈 性能优化

### Token 缓存
- `tenant_access_token` 有效期 2 小时
- `jsapi_ticket` 有效期可在返回数据中查看
- 建议在应用层实现缓存机制

### 示例缓存实现：
```python
from datetime import datetime, timedelta

class TokenCache:
    def __init__(self):
        self.token = None
        self.expire_time = None
    
    def get_token(self):
        if self.token and datetime.now() < self.expire_time:
            return self.token
        # 重新获取 token
        return self.refresh_token()
```

## 🚢 生产环境部署

### 1. 使用 Gunicorn
```bash
gunicorn -w 4 -b 0.0.0.0:3000 server:app
```

### 2. 使用 Supervisor 守护进程
```ini
[program:feishu_web_app]
command=/path/to/venv/bin/gunicorn -w 4 -b 127.0.0.1:3000 server:app
directory=/path/to/feishu_web_app
user=www-data
autostart=true
autorestart=true
```

### 3. Nginx 配置
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## 📚 扩展功能

### 可以添加的 JSAPI 功能

1. **扫一扫**
```javascript
tt.scanCode({ success: (res) => console.log(res.text) });
```

2. **选择图片**
```javascript
tt.chooseImage({ count: 1, success: (res) => console.log(res.tempFilePaths) });
```

3. **获取位置**
```javascript
tt.getLocation({ type: 'gcj02', success: (res) => console.log(res.latitude, res.longitude) });
```

4. **分享**
```javascript
tt.shareToChat({ title: '标题', text: '内容', success: () => console.log('分享成功') });
```

更多 JSAPI 请参考：https://open.feishu.cn/document/uYjL24iN/uMTMuMTMuMTM/

## 🆘 获取帮助

- 飞书开放平台文档：https://open.feishu.cn/document/
- 飞书开发者社区：https://open.feishu.cn/community
- 项目 Issues：提交问题反馈

## 📝 更新日志

### v1.0.0 (2025-11-03)
- ✅ 完成服务端鉴权模块
- ✅ 完成前端 JSAPI 调用
- ✅ 实现用户信息展示
- ✅ 添加完整文档
- ✅ 提供启动脚本

## 📄 许可证

MIT License

---

**祝开发顺利！🎉**

有问题欢迎反馈！


