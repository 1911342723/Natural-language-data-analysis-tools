# é£ä¹¦ç½‘é¡µåº”ç”¨å¼€å‘ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªåŸºäº Flask å’Œ JSSDK çš„é£ä¹¦ç½‘é¡µåº”ç”¨å®Œæ•´ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•è¿›è¡Œ JSAPI é‰´æƒå¹¶è°ƒç”¨é£ä¹¦å®¢æˆ·ç«¯èƒ½åŠ›ã€‚

## é¡¹ç›®ç»“æ„

```
feishu_web_app/
â”œâ”€â”€ README.md              # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ .env                   # ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆå­˜å‚¨ APP_ID å’Œ APP_SECRETï¼‰
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ auth.py                # æœåŠ¡ç«¯é‰´æƒæ¨¡å—
â”œâ”€â”€ server.py              # æœåŠ¡ç«¯æ ¸å¿ƒä¸šåŠ¡ä»£ç 
â”œâ”€â”€ public/                # å‰ç«¯é™æ€èµ„æº
â”‚   â”œâ”€â”€ index.js          # å‰ç«¯äº¤äº’ä»£ç 
â”‚   â””â”€â”€ index.css         # å‰ç«¯æ ·å¼æ–‡ä»¶
â””â”€â”€ templates/             # å‰ç«¯é¡µé¢æ¨¡æ¿
    â””â”€â”€ index.html        # ç”¨æˆ·ä¿¡æ¯å±•ç¤ºé¡µé¢
```

## åŠŸèƒ½ç‰¹æ€§

### æœåŠ¡ç«¯åŠŸèƒ½
- âœ… ä½¿ç”¨ App ID å’Œ App Secret è·å– `tenant_access_token`
- âœ… ä½¿ç”¨ `tenant_access_token` è·å– `jsapi_ticket`
- âœ… ç”Ÿæˆ JSSDK æƒé™éªŒè¯ç­¾åï¼ˆsignatureï¼‰
- âœ… æä¾›é‰´æƒå‚æ•°æ¥å£ç»™å‰ç«¯

### å‰ç«¯åŠŸèƒ½
- âœ… å¼•å…¥é£ä¹¦ JSSDK
- âœ… è°ƒç”¨ `h5sdk.config` è¿›è¡Œ JSAPI é‰´æƒ
- âœ… è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åã€å¤´åƒã€Open IDï¼‰
- âœ… å±•ç¤ºç”¨æˆ·ä¿¡æ¯ç•Œé¢
- âœ… æ”¯æŒç§»åŠ¨ç«¯è°ƒè¯•ï¼ˆvConsoleï¼‰

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£… Python 3.7 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼š

```bash
python --version
```

### 2. å®‰è£…ä¾èµ–

```bash
cd feishu_web_app
pip install -r requirements.txt
```

### 3. é…ç½®åº”ç”¨ä¿¡æ¯

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„é£ä¹¦åº”ç”¨ä¿¡æ¯ï¼š

```env
APP_ID=ä½ çš„åº”ç”¨ID
APP_SECRET=ä½ çš„åº”ç”¨å¯†é’¥
FEISHU_HOST=https://open.feishu.cn
```

> **è·å–åº”ç”¨ä¿¡æ¯ï¼š**
> 1. è®¿é—® [é£ä¹¦å¼€å‘è€…åå°](https://open.feishu.cn/app)
> 2. åˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªä¼ä¸šè‡ªå»ºåº”ç”¨
> 3. åœ¨åº”ç”¨è¯¦æƒ…é¡µçš„"å‡­è¯ä¸åŸºç¡€ä¿¡æ¯"ä¸­è·å– App ID å’Œ App Secret

### 4. é…ç½®é£ä¹¦åº”ç”¨

åœ¨ [é£ä¹¦å¼€å‘è€…åå°](https://open.feishu.cn/app) è¿›è¡Œä»¥ä¸‹é…ç½®ï¼š

#### 4.1 æ·»åŠ ç½‘é¡µåº”ç”¨èƒ½åŠ›
1. è¿›å…¥åº”ç”¨è¯¦æƒ…é¡µ
2. ç‚¹å‡»"åº”ç”¨èƒ½åŠ›" > "æ·»åŠ åº”ç”¨èƒ½åŠ›"
3. é€‰æ‹©"ç½‘é¡µåº”ç”¨"

#### 4.2 é…ç½®åº”ç”¨ä¸»é¡µåœ°å€
1. è¿›å…¥"åº”ç”¨èƒ½åŠ›" > "ç½‘é¡µåº”ç”¨"
2. å¡«å†™æ¡Œé¢ç«¯ä¸»é¡µï¼š`http://127.0.0.1:3000`ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
3. ç”Ÿäº§ç¯å¢ƒéœ€è¦å¡«å†™å…¬ç½‘åœ°å€

#### 4.3 é…ç½® H5 å¯ä¿¡åŸŸå
1. è¿›å…¥"å®‰å…¨è®¾ç½®" > "H5 å¯ä¿¡åŸŸå"
2. æ·»åŠ ï¼š`127.0.0.1:3000`ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
3. ç”Ÿäº§ç¯å¢ƒéœ€è¦æ·»åŠ å®é™…åŸŸå

#### 4.4 ç”³è¯·æƒé™ï¼ˆå¦‚éœ€è¦ï¼‰
1. è¿›å…¥"æƒé™ç®¡ç†"
2. ç”³è¯·"è·å–ç”¨æˆ·ä¿¡æ¯"æƒé™ï¼ˆå¦‚æœéœ€è¦è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼‰

### 5. å¯åŠ¨æœåŠ¡

```bash
python server.py
```

å¯åŠ¨æˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
==================================================
é£ä¹¦ç½‘é¡µåº”ç”¨é…ç½®ä¿¡æ¯ï¼š
APP_ID: cli_xxxxxxxxxxxx
APP_SECRET: ****************************
FEISHU_HOST: https://open.feishu.cn
==================================================

ğŸš€ å¯åŠ¨é£ä¹¦ç½‘é¡µåº”ç”¨æœåŠ¡...
ğŸ“ è®¿é—®åœ°å€: http://127.0.0.1:3000
âš ï¸  è¯·ç¡®ä¿åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­æ‰“å¼€æ­¤ç½‘é¡µåº”ç”¨

 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:3000
```

### 6. è®¿é—®åº”ç”¨

âš ï¸ **é‡è¦ï¼šå¿…é¡»åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­æ‰“å¼€**

æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

#### æ–¹å¼ä¸€ï¼šé€šè¿‡é£ä¹¦å·¥ä½œå°è®¿é—®
1. æ‰“å¼€é£ä¹¦å®¢æˆ·ç«¯
2. è¿›å…¥"å·¥ä½œå°"
3. æ‰¾åˆ°ä½ çš„åº”ç”¨å¹¶ç‚¹å‡»æ‰“å¼€

#### æ–¹å¼äºŒï¼šé€šè¿‡æ¶ˆæ¯å¡ç‰‡è®¿é—®
1. åœ¨é£ä¹¦ç¾¤èŠæˆ–ç§èŠä¸­å‘é€åº”ç”¨é“¾æ¥
2. ç‚¹å‡»é“¾æ¥åœ¨é£ä¹¦å†…æ‰“å¼€

#### æ–¹å¼ä¸‰ï¼šå¼€å‘è°ƒè¯•
1. åœ¨é£ä¹¦å®¢æˆ·ç«¯å†…ç½®æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®ï¼š`http://127.0.0.1:3000`

## å¼€å‘è¯´æ˜

### æ ¸å¿ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯é¡µé¢   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  æœåŠ¡ç«¯æ¥å£  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  é£ä¹¦å¼€æ”¾å¹³å° â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                        â”‚                        â”‚
      â”‚  1. è¯·æ±‚é‰´æƒå‚æ•°        â”‚  2. è·å– token/ticket  â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚
      â”‚                        â”‚                        â”‚
      â”‚  4. è¿”å›ç­¾åç­‰å‚æ•°      â”‚  3. è¿”å› token/ticket  â”‚
      â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
      â”‚                        â”‚                        â”‚
      â”‚  5. è°ƒç”¨ h5sdk.config è¿›è¡Œé‰´æƒ                  â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚
      â”‚                                                 â”‚
      â”‚  6. é‰´æƒæˆåŠŸï¼Œè°ƒç”¨ JSAPI                         â”‚
      â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
```

### ç­¾åç”Ÿæˆè§„åˆ™

ç­¾åç”Ÿæˆæ­¥éª¤ï¼š
1. è·å–å‚æ•°ï¼š`jsapi_ticket`ã€`noncestr`ã€`timestamp`ã€`url`
2. æŒ‰å­—æ®µå ASCII ç æ’åº
3. æ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼š`jsapi_ticket={ticket}&noncestr={noncestr}&timestamp={timestamp}&url={url}`
4. ä½¿ç”¨ SHA-1 ç®—æ³•åŠ å¯†ç”Ÿæˆç­¾å

ç¤ºä¾‹ä»£ç ï¼ˆ`server.py`ï¼‰ï¼š

```python
verify_str = f"jsapi_ticket={ticket}&noncestr={NONCE_STR}&timestamp={timestamp}&url={url}"
signature = hashlib.sha1(verify_str.encode("utf-8")).hexdigest()
```

### å‰ç«¯é‰´æƒæµç¨‹

å‰ç«¯é‰´æƒæ ¸å¿ƒä»£ç ï¼ˆ`public/index.js`ï¼‰ï¼š

```javascript
// 1. è·å–å½“å‰é¡µé¢ URL
const url = encodeURIComponent(location.href.split("#")[0]);

// 2. å‘æœåŠ¡ç«¯è¯·æ±‚é‰´æƒå‚æ•°
fetch(`/get_config_parameters?url=${url}`)
  .then(response => response.json())
  .then(res => {
    // 3. è°ƒç”¨ config æ¥å£è¿›è¡Œé‰´æƒ
    window.h5sdk.config({
      appId: res.appid,
      timestamp: res.timestamp,
      nonceStr: res.noncestr,
      signature: res.signature,
      jsApiList: [],
      onSuccess: (res) => {
        console.log('é‰´æƒæˆåŠŸ');
      },
      onFail: (err) => {
        console.error('é‰´æƒå¤±è´¥:', err);
      }
    });
    
    // 4. åœ¨ ready å›è°ƒä¸­è°ƒç”¨ JSAPI
    window.h5sdk.ready(() => {
      tt.getUserInfo({
        success: (res) => {
          // è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ
        }
      });
    });
  });
```

## å¸¸è§é—®é¢˜

### 1. é‰´æƒå¤±è´¥ï¼šsignature invalid

**åŸå› ï¼š**
- URL ä¸åŒ¹é…ï¼ˆå‰ç«¯å’Œåç«¯çš„ URL ä¸ä¸€è‡´ï¼‰
- ç­¾åç”Ÿæˆé”™è¯¯
- jsapi_ticket è¿‡æœŸ

**è§£å†³æ–¹æ³•ï¼š**
- ç¡®ä¿å‰ç«¯ä½¿ç”¨ `encodeURIComponent(location.href.split("#")[0])` è·å– URL
- æ£€æŸ¥æœåŠ¡ç«¯ç­¾åç”Ÿæˆé€»è¾‘
- ç¡®è®¤ H5 å¯ä¿¡åŸŸåé…ç½®æ­£ç¡®

### 2. æç¤º"è¯·åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­æ‰“å¼€"

**åŸå› ï¼š**
åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€äº†ç½‘é¡µåº”ç”¨

**è§£å†³æ–¹æ³•ï¼š**
å¿…é¡»åœ¨é£ä¹¦å®¢æˆ·ç«¯ï¼ˆæ¡Œé¢ç‰ˆæˆ–ç§»åŠ¨ç‰ˆï¼‰ä¸­æ‰“å¼€

### 3. IP ç™½åå•é”™è¯¯ï¼ˆ99991401ï¼‰

**åŸå› ï¼š**
åº”ç”¨å¼€å¯äº† IP ç™½åå•é™åˆ¶ï¼Œå½“å‰æœåŠ¡å™¨ IP ä¸åœ¨ç™½åå•ä¸­

**è§£å†³æ–¹æ³•ï¼š**
1. è¿›å…¥é£ä¹¦å¼€å‘è€…åå°
2. è¿›å…¥"å®‰å…¨è®¾ç½®" > "IP ç™½åå•"
3. æ·»åŠ æœåŠ¡å™¨ IP æˆ–å…³é—­ IP ç™½åå•

### 4. è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥

**åŸå› ï¼š**
ç¼ºå°‘ç›¸åº”çš„ API æƒé™

**è§£å†³æ–¹æ³•ï¼š**
1. è¿›å…¥é£ä¹¦å¼€å‘è€…åå°
2. è¿›å…¥"æƒé™ç®¡ç†"
3. ç”³è¯·"è·å–ç”¨æˆ·ä¿¡æ¯"æƒé™
4. ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡

## æ‰©å±•åŠŸèƒ½

### æ·»åŠ æ›´å¤š JSAPI è°ƒç”¨

å‚è€ƒ `public/index.js` ä¸­çš„ç¤ºä¾‹ä»£ç ï¼š

```javascript
// æ‰«ä¸€æ‰«
function scanQRCode() {
  tt.scanCode({
    success: (res) => {
      console.log('æ‰«ç ç»“æœ:', res.text);
    }
  });
}

// é€‰æ‹©å›¾ç‰‡
function chooseImage() {
  tt.chooseImage({
    count: 1,
    success: (res) => {
      console.log('é€‰æ‹©çš„å›¾ç‰‡:', res.tempFilePaths);
    }
  });
}

// è·å–ä½ç½®
function getLocation() {
  tt.getLocation({
    type: 'gcj02',
    success: (res) => {
      console.log('ä½ç½®:', res.latitude, res.longitude);
    }
  });
}
```

æ›´å¤š JSAPI è¯·å‚è€ƒï¼š[é£ä¹¦ H5 JSAPI æ–‡æ¡£](https://open.feishu.cn/document/uYjL24iN/uMTMuMTMuMTM/)

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. ä½¿ç”¨ Gunicorn éƒ¨ç½²

```bash
gunicorn -w 4 -b 0.0.0.0:3000 server:app
```

### 2. ä½¿ç”¨ Nginx åå‘ä»£ç†

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. é…ç½® HTTPS

ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ HTTPSï¼š

```bash
# ä½¿ç”¨ Let's Encrypt è·å–å…è´¹è¯ä¹¦
sudo certbot --nginx -d your-domain.com
```

## å‚è€ƒèµ„æ–™

- [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/)
- [ç½‘é¡µåº”ç”¨å¼€å‘æŒ‡å—](https://open.feishu.cn/document/uYjL24iN/uMTMuMTMuMTM/introduction)
- [H5 JSAPI æ–‡æ¡£](https://open.feishu.cn/document/uYjL24iN/uMTMuMTMuMTM/)
- [JSSDK é‰´æƒ](https://open.feishu.cn/document/uYjL24iN/uYTM5UjL2ETO14iNxkTN/h5_js_sdk/authorization)
- [Flask å®˜æ–¹æ–‡æ¡£](https://flask.palletsprojects.com/)

## è®¸å¯è¯

MIT License

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è®¿é—® [é£ä¹¦å¼€æ”¾å¹³å°ç¤¾åŒº](https://open.feishu.cn/community) å¯»æ±‚å¸®åŠ©ã€‚


