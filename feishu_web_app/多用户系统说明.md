# ğŸ‘¥ é£ä¹¦å¤šç”¨æˆ·ç™»å½•ç³»ç»Ÿè¯´æ˜

## æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†åŸºäºé£ä¹¦å…ç™»æˆæƒçš„å¤šç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼Œæ”¯æŒå¤šäººåŒæ—¶åœ¨çº¿ä½¿ç”¨ï¼Œæ¯ä¸ªç”¨æˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»ã€‚

---

## æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **é£ä¹¦å…ç™»æˆæƒ**
   - ä¸€é”®ç™»å½•ï¼Œæ— éœ€è¾“å…¥è´¦å·å¯†ç 
   - è‡ªåŠ¨è·å–é£ä¹¦ç”¨æˆ·ä¿¡æ¯
   - å®‰å…¨å¯é 

2. **å¤šç”¨æˆ·æ”¯æŒ**
   - æ”¯æŒå¤šäººåŒæ—¶åœ¨çº¿
   - æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ Session
   - æ•°æ®å®Œå…¨éš”ç¦»

3. **è‡ªåŠ¨è¯†åˆ«**
   - æ‰“å¼€åº”ç”¨è‡ªåŠ¨æ£€æŸ¥ç™»å½•çŠ¶æ€
   - å·²ç™»å½•ç”¨æˆ·ç›´æ¥è¿›å…¥
   - æœªç™»å½•ç”¨æˆ·å¼•å¯¼ç™»å½•

4. **æƒé™æ§åˆ¶**
   - ä½¿ç”¨ `@login_required` è£…é¥°å™¨ä¿æŠ¤æ¥å£
   - æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—®å—ä¿æŠ¤èµ„æº
   - æ”¯æŒè§’è‰²æƒé™æ‰©å±•

---

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é£ä¹¦å®¢æˆ·ç«¯ï¼ˆç”¨æˆ·Aï¼‰                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  å‰ç«¯é¡µé¢ (index_with_auth.html)    â”‚        â”‚
â”‚  â”‚  - æ£€æŸ¥ç™»å½•çŠ¶æ€                      â”‚        â”‚
â”‚  â”‚  - é£ä¹¦æˆæƒç™»å½•                      â”‚        â”‚
â”‚  â”‚  - ç”¨æˆ·ä¿¡æ¯å±•ç¤º                      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTPS + Session Cookie
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Flask æœåŠ¡å™¨ (server_with_auth.py)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Session ç®¡ç†                        â”‚        â”‚
â”‚  â”‚  - ç”¨æˆ·A: session_id_A              â”‚        â”‚
â”‚  â”‚  - ç”¨æˆ·B: session_id_B              â”‚        â”‚
â”‚  â”‚  - ç”¨æˆ·C: session_id_C              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                 â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  ç”¨æˆ·è®¤è¯æ¨¡å— (user_auth.py)        â”‚        â”‚
â”‚  â”‚  - å…ç™»æˆæƒ                          â”‚        â”‚
â”‚  â”‚  - ç”¨æˆ·ä¿¡æ¯è·å–                      â”‚        â”‚
â”‚  â”‚  - ç™»å½•éªŒè¯                          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ API Calls
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é£ä¹¦å¼€æ”¾å¹³å°                          â”‚
â”‚  - ç”¨æˆ·æˆæƒ                                       â”‚
â”‚  - ç”¨æˆ·ä¿¡æ¯                                       â”‚
â”‚  - Access Token                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç™»å½•æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·æ‰“å¼€åº”ç”¨
    â†“
æ£€æŸ¥ç™»å½•çŠ¶æ€ (/api/check_login)
    â†“
    â”œâ”€â”€â”€ å·²ç™»å½• â”€â”€â†’ è·å–ç”¨æˆ·ä¿¡æ¯ (/api/current_user)
    â”‚                    â†“
    â”‚              æ˜¾ç¤ºç”¨æˆ·ç•Œé¢
    â”‚
    â””â”€â”€â”€ æœªç™»å½• â”€â”€â†’ æ˜¾ç¤ºç™»å½•æŒ‰é’®
                        â†“
                  ç”¨æˆ·ç‚¹å‡»"é£ä¹¦ç™»å½•"
                        â†“
                è°ƒç”¨ tt.requestAuthCode()
                        â†“
                  è·å–æˆæƒç  (code)
                        â†“
                å‘é€åˆ°æœåŠ¡ç«¯ (/api/login)
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     æœåŠ¡ç«¯å¤„ç†ç™»å½•è¯·æ±‚          â”‚
        â”‚  1. ç”¨ code æ¢ user_access_tokenâ”‚
        â”‚  2. ç”¨ token è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯   â”‚
        â”‚  3. ä¿å­˜åˆ° session              â”‚
        â”‚  4. è¿”å›ç”¨æˆ·ä¿¡æ¯                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                  ç™»å½•æˆåŠŸ
                        â†“
                æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ç•Œé¢
```

---

## æ ¸å¿ƒä»£ç è§£æ

### 1. æœåŠ¡ç«¯ - ç”¨æˆ·è®¤è¯æ¨¡å—

**æ–‡ä»¶ï¼š** `user_auth.py`

#### å…ç™»æˆæƒæµç¨‹
```python
def get_user_info_by_code(self, code):
    """é€šè¿‡æˆæƒç è·å–ç”¨æˆ·ä¿¡æ¯"""
    # 1. è·å– tenant_access_token
    token = self.get_tenant_access_token()
    
    # 2. ç”¨ code æ¢å– user_access_token
    url = f"{self.feishu_host}/open-api/authen/v1/access_token"
    data = {"grant_type": "authorization_code", "code": code}
    response = requests.post(url, headers={...}, json=data)
    
    user_access_token = response.json()["data"]["access_token"]
    
    # 3. è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
    user_info = self.get_user_detail(user_access_token)
    
    return user_info
```

#### ç™»å½•éªŒè¯è£…é¥°å™¨
```python
@login_required
def protected_api():
    """å—ä¿æŠ¤çš„æ¥å£ï¼Œåªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½è®¿é—®"""
    user = get_current_user()
    # ä¸šåŠ¡é€»è¾‘
    return jsonify({"user": user["name"]})
```

### 2. æœåŠ¡ç«¯ - ç™»å½•æ¥å£

**æ–‡ä»¶ï¼š** `server_with_auth.py`

```python
@app.route("/api/login", methods=["POST"])
def login():
    """ç”¨æˆ·ç™»å½•æ¥å£"""
    code = request.get_json().get("code")
    
    # é€šè¿‡ code è·å–ç”¨æˆ·ä¿¡æ¯
    user_info = user_auth.get_user_info_by_code(code)
    
    # ä¿å­˜åˆ° sessionï¼ˆæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ï¼‰
    session["user_info"] = user_info
    session["login_time"] = time.time()
    
    return jsonify({"code": 0, "data": user_info})
```

### 3. å‰ç«¯ - ç™»å½•é€»è¾‘

**æ–‡ä»¶ï¼š** `public/auth.js`

```javascript
function doLogin() {
  // è°ƒç”¨é£ä¹¦ JSAPI è·å–æˆæƒç 
  tt.requestAuthCode({
    appId: window.h5sdk.config.appId,
    success: (res) => {
      // å‘é€æˆæƒç åˆ°æœåŠ¡ç«¯
      fetch("/api/login", {
        method: "POST",
        body: JSON.stringify({ code: res.code })
      })
      .then(response => response.json())
      .then(result => {
        if (result.code === 0) {
          // ç™»å½•æˆåŠŸï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
          showUserInfo(result.data);
        }
      });
    }
  });
}
```

---

## Session ç®¡ç†

### é»˜è®¤é…ç½®ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰

```python
app.config['SECRET_KEY'] = secrets.token_hex(32)
app.config['SESSION_TYPE'] = 'filesystem'
app.config['PERMANENT_SESSION_LIFETIME'] = 86400  # 24å°æ—¶
```

**ç‰¹ç‚¹ï¼š**
- âœ… ç®€å•æ˜“ç”¨ï¼Œæ— éœ€é¢å¤–ä¾èµ–
- âŒ å¤šè¿›ç¨‹ç¯å¢ƒä¸‹å¯èƒ½æœ‰é—®é¢˜
- âŒ æœåŠ¡å™¨é‡å¯å session ä¸¢å¤±

### æ¨èé…ç½®ï¼ˆRedisï¼‰

```python
import redis
from flask_session import Session

app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.from_url('redis://localhost:6379/0')
Session(app)
```

**ç‰¹ç‚¹ï¼š**
- âœ… æ”¯æŒå¤šè¿›ç¨‹/å¤šæœåŠ¡å™¨
- âœ… é«˜æ€§èƒ½
- âœ… æŒä¹…åŒ–å­˜å‚¨
- âœ… å¯è®¾ç½®è¿‡æœŸæ—¶é—´

### å®‰è£… Redis Session

```bash
pip install flask-session redis
```

---

## å¤šç”¨æˆ·æ•°æ®éš”ç¦»

### æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ Session

æ¯ä¸ªç”¨æˆ·çš„ session ç‹¬ç«‹å­˜å‚¨ï¼Œäº’ä¸å¹²æ‰°ï¼š

```python
@app.route("/api/user/data", methods=["GET"])
@login_required
def get_user_data():
    user = get_current_user()
    user_id = user["open_id"]
    
    # æ ¹æ® user_id æŸ¥è¯¢è¯¥ç”¨æˆ·çš„æ•°æ®
    data = query_data_by_user_id(user_id)
    
    return jsonify({"data": data})
```

### æ–¹æ¡ˆäºŒï¼šæ•°æ®åº“éš”ç¦»

åœ¨æ•°æ®åº“ä¸­ä¸ºæ¯æ¡è®°å½•æ·»åŠ  `user_id` å­—æ®µï¼š

```python
# ç¤ºä¾‹ï¼šä¿å­˜ç”¨æˆ·çš„åˆ†æå†å²
def save_analysis_history(content):
    user = get_current_user()
    
    db.execute("""
        INSERT INTO analysis_history (user_id, content, created_at)
        VALUES (?, ?, ?)
    """, (user["open_id"], content, datetime.now()))
```

æŸ¥è¯¢æ—¶åªè¿”å›å½“å‰ç”¨æˆ·çš„æ•°æ®ï¼š

```python
def get_user_history():
    user = get_current_user()
    
    return db.query("""
        SELECT * FROM analysis_history
        WHERE user_id = ?
        ORDER BY created_at DESC
    """, (user["open_id"],))
```

---

## æ¥å£æƒé™æ§åˆ¶

### å…¬å¼€æ¥å£ï¼ˆæ— éœ€ç™»å½•ï¼‰

```python
@app.route("/api/public/info", methods=["GET"])
def public_info():
    """å…¬å¼€æ¥å£ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®"""
    return jsonify({"message": "è¿™æ˜¯å…¬å¼€ä¿¡æ¯"})
```

### å—ä¿æŠ¤æ¥å£ï¼ˆéœ€è¦ç™»å½•ï¼‰

```python
@app.route("/api/private/data", methods=["GET"])
@login_required
def private_data():
    """å—ä¿æŠ¤æ¥å£ï¼Œåªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½è®¿é—®"""
    user = get_current_user()
    return jsonify({"message": f"æ¬¢è¿ï¼Œ{user['name']}"})
```

### è§’è‰²æƒé™ï¼ˆæ‰©å±•ï¼‰

```python
def admin_required(f):
    """ç®¡ç†å‘˜æƒé™éªŒè¯"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        user = get_current_user()
        if not user or user.get("role") != "admin":
            return jsonify({"code": 403, "msg": "æƒé™ä¸è¶³"}), 403
        return f(*args, **kwargs)
    return decorated_function

@app.route("/api/admin/users", methods=["GET"])
@login_required
@admin_required
def admin_users():
    """ç®¡ç†å‘˜æ¥å£"""
    # åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®
    return jsonify({"users": get_all_users()})
```

---

## ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨å¤šç”¨æˆ·ç‰ˆæœ¬

```bash
# å¼€å‘ç¯å¢ƒ
python server_with_auth.py

# ç”Ÿäº§ç¯å¢ƒ
gunicorn -w 4 -b 0.0.0.0:8000 server_with_auth:app
```

### è®¿é—®åº”ç”¨

1. åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­æ‰“å¼€åº”ç”¨
2. ç‚¹å‡»"é£ä¹¦ç™»å½•"æŒ‰é’®
3. è‡ªåŠ¨è·³è½¬å¹¶è·å–ç”¨æˆ·ä¿¡æ¯
4. ç™»å½•æˆåŠŸï¼Œæ˜¾ç¤ºç”¨æˆ·ç•Œé¢

### å¤šç”¨æˆ·æµ‹è¯•

1. ç”¨æˆ·Aåœ¨è®¾å¤‡Aä¸Šç™»å½•
2. ç”¨æˆ·Båœ¨è®¾å¤‡Bä¸Šç™»å½•
3. ä¸¤ä¸ªç”¨æˆ·åŒæ—¶åœ¨çº¿
4. å„è‡ªçœ‹åˆ°è‡ªå·±çš„æ•°æ®

---

## é›†æˆåˆ°ç°æœ‰é¡¹ç›®

### æ–¹æ³•ä¸€ï¼šç›´æ¥ä½¿ç”¨å¤šç”¨æˆ·ç‰ˆæœ¬

```bash
# ä½¿ç”¨ server_with_auth.py æ›¿ä»£ server.py
python server_with_auth.py
```

### æ–¹æ³•äºŒï¼šåœ¨ç°æœ‰ä»£ç ä¸­æ·»åŠ è®¤è¯

```python
# åœ¨ä½ çš„ Flask åº”ç”¨ä¸­
from user_auth import UserAuth, login_required, get_current_user

# åˆå§‹åŒ–
user_auth = UserAuth(APP_ID, APP_SECRET, FEISHU_HOST)

# ä¸ºæ¥å£æ·»åŠ ç™»å½•éªŒè¯
@app.route("/api/your_api", methods=["POST"])
@login_required
def your_api():
    user = get_current_user()
    # ä½ çš„ä¸šåŠ¡é€»è¾‘
    return jsonify({"data": "..."})
```

---

## å®‰å…¨å»ºè®®

### 1. Session å®‰å…¨

```python
# ä½¿ç”¨å¼ºéšæœºå¯†é’¥
app.config['SECRET_KEY'] = secrets.token_hex(32)

# å¯ç”¨ HTTPS-only cookiesï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
app.config['SESSION_COOKIE_SECURE'] = True
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
```

### 2. CSRF ä¿æŠ¤

```bash
pip install flask-wtf
```

```python
from flask_wtf.csrf import CSRFProtect

csrf = CSRFProtect(app)
```

### 3. é™æµä¿æŠ¤

```python
from flask_limiter import Limiter

limiter = Limiter(app, key_func=lambda: get_current_user()["open_id"])

@app.route("/api/login", methods=["POST"])
@limiter.limit("5 per minute")
def login():
    # é™åˆ¶æ¯åˆ†é’Ÿæœ€å¤šç™»å½•5æ¬¡
    pass
```

---

## å¸¸è§é—®é¢˜

### Q1: å¤šä¸ªç”¨æˆ·ç™»å½•åäº’ç›¸å¹²æ‰°ï¼Ÿ

**A:** æ£€æŸ¥ `SECRET_KEY` æ˜¯å¦é…ç½®ï¼Œsession æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

### Q2: æœåŠ¡å™¨é‡å¯åç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ï¼Ÿ

**A:** ä½¿ç”¨ Redis å­˜å‚¨ sessionï¼Œé¿å…æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ã€‚

### Q3: å¦‚ä½•å®ç°"è®°ä½æˆ‘"åŠŸèƒ½ï¼Ÿ

**A:** è®¾ç½® session çš„æœ‰æ•ˆæœŸï¼š
```python
session.permanent = True
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=30)
```

### Q4: å¦‚ä½•è¸¢å‡ºæŸä¸ªç”¨æˆ·ï¼Ÿ

**A:** å¦‚æœä½¿ç”¨ Redisï¼Œå¯ä»¥åˆ é™¤è¯¥ç”¨æˆ·çš„ sessionï¼š
```python
redis_client.delete(f"session:{user_session_id}")
```

---

## ä¸‹ä¸€æ­¥

- [ ] æµ‹è¯•å¤šç”¨æˆ·ç™»å½•
- [ ] é…ç½® Redis sessionï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] å®ç°ä¸šåŠ¡æ¥å£çš„æƒé™æ§åˆ¶
- [ ] æ·»åŠ ç”¨æˆ·è§’è‰²ç®¡ç†
- [ ] å®ç°æ•°æ®éš”ç¦»é€»è¾‘
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**ç°åœ¨ä½ çš„åº”ç”¨å·²ç»æ”¯æŒå¤šç”¨æˆ·ç™»å½•äº†ï¼** ğŸ‰

å¤šä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œæ•°æ®å®Œå…¨éš”ç¦»ï¼Œå®‰å…¨å¯é ï¼

