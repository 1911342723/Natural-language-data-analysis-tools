# ğŸ”— é£ä¹¦ç™»å½•ç³»ç»Ÿé›†æˆåˆ°æ•°æ®åˆ†æå·¥å…·æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•å°†é£ä¹¦å¤šç”¨æˆ·ç™»å½•ç³»ç»Ÿé›†æˆåˆ°ä½ ç°æœ‰çš„æ•°æ®åˆ†æå·¥å…·ä¸­ï¼Œå®ç°ï¼š
- âœ… ç”¨æˆ·èº«ä»½è¯†åˆ«
- âœ… åˆ¤æ–­æ˜¯å¦ä¸ºä¼ä¸šå†…ç”¨æˆ·
- âœ… çŠ¶æ€æŒä¹…åŒ–ï¼Œåˆ·æ–°ä¸ä¸¢å¤±
- âœ… åˆ†æç»“æœä¿å­˜å’Œæ¢å¤
- âœ… æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„æ•°æ®ç©ºé—´

---

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä½ çš„æ•°æ®åˆ†æå·¥å…·ï¼ˆå‰ç«¯ï¼‰                    â”‚
â”‚                                                      â”‚
â”‚  - æ–‡ä»¶ä¸Šä¼                                           â”‚
â”‚  - æ•°æ®é¢„è§ˆ                                          â”‚
â”‚  - è‡ªç„¶è¯­è¨€æŸ¥è¯¢                                       â”‚
â”‚  - å›¾è¡¨å±•ç¤º                                          â”‚
â”‚  - ä»£ç æ‰§è¡Œ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP API
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é£ä¹¦ç™»å½•ç³»ç»Ÿï¼ˆä¸­é—´å±‚ï¼‰                         â”‚
â”‚                                                      â”‚
â”‚  âœ… ç”¨æˆ·è®¤è¯å’Œé‰´æƒ                                    â”‚
â”‚  âœ… Session ç®¡ç†                                     â”‚
â”‚  âœ… æ•°æ®æŒä¹…åŒ–                                        â”‚
â”‚  âœ… æƒé™æ§åˆ¶                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ è°ƒç”¨
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä½ çš„æ•°æ®åˆ†æåç«¯é€»è¾‘                          â”‚
â”‚                                                      â”‚
â”‚  - AI Agent                                         â”‚
â”‚  - ä»£ç æ‰§è¡Œå¼•æ“                                       â”‚
â”‚  - æ•°æ®å¤„ç†                                          â”‚
â”‚  - å›¾è¡¨ç”Ÿæˆ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ–¹æ¡ˆä¸€ï¼šä¿®æ”¹ç°æœ‰åç«¯ï¼ˆæ¨èï¼‰

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

åœ¨ä½ çš„æ•°æ®åˆ†æå·¥å…·ç›®å½•ä¸‹ï¼š

```bash
cd D:\æˆ‘çš„é¡¹ç›®\æ•°æ®åˆ†æå·¥å…·\backend
pip install flask-session python-dotenv
```

### æ­¥éª¤ 2ï¼šå¤åˆ¶å¿…è¦æ–‡ä»¶

å°†ä»¥ä¸‹æ–‡ä»¶å¤åˆ¶åˆ°ä½ çš„ backend ç›®å½•ï¼š

```bash
copy ..\feishu_web_app\user_auth.py backend\core\
copy ..\feishu_web_app\database.py backend\core\
copy ..\feishu_web_app\.env backend\
```

### æ­¥éª¤ 3ï¼šä¿®æ”¹ä½ çš„ `backend/main.py`

åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ï¼š

```python
from core.user_auth import UserAuth, login_required, get_current_user
from core.database import db
import secrets

# è·å–é£ä¹¦é…ç½®
APP_ID = os.getenv("APP_ID")
APP_SECRET = os.getenv("APP_SECRET")
FEISHU_HOST = os.getenv("FEISHU_HOST", "https://open.feishu.cn")

# é…ç½® Session
app.config['SECRET_KEY'] = secrets.token_hex(32)
app.config['SESSION_TYPE'] = 'filesystem'
app.config['PERMANENT_SESSION_LIFETIME'] = 86400

# åˆå§‹åŒ–ç”¨æˆ·è®¤è¯
user_auth = UserAuth(APP_ID, APP_SECRET, FEISHU_HOST)
```

### æ­¥éª¤ 4ï¼šæ·»åŠ ç™»å½•æ¥å£

åœ¨ `backend/main.py` æˆ– `backend/api/` ç›®å½•ä¸‹æ·»åŠ ï¼š

```python
@app.route("/api/login", methods=["POST"])
def login():
    """é£ä¹¦ç™»å½•"""
    try:
        data = request.get_json()
        code = data.get("code")
        
        # è·å–ç”¨æˆ·ä¿¡æ¯
        user_info = user_auth.get_user_info_by_code(code)
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        db.save_user(user_info)
        
        # ä¿å­˜åˆ° session
        session["user_info"] = user_info
        session["login_time"] = time.time()
        session.permanent = True
        
        return jsonify({
            "code": 0,
            "msg": "ç™»å½•æˆåŠŸ",
            "data": user_info
        })
    except Exception as e:
        return jsonify({"code": -1, "msg": str(e)}), 500

@app.route("/api/check_login", methods=["GET"])
def check_login():
    """æ£€æŸ¥ç™»å½•çŠ¶æ€"""
    user_info = get_current_user()
    if user_info:
        return jsonify({
            "code": 0,
            "data": {"logged_in": True, "user": user_info}
        })
    return jsonify({
        "code": 0,
        "data": {"logged_in": False}
    })
```

### æ­¥éª¤ 5ï¼šä¿æŠ¤ç°æœ‰æ¥å£

ä¸ºéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„æ¥å£æ·»åŠ  `@login_required` è£…é¥°å™¨ï¼š

```python
@app.route("/api/agent/chat", methods=["POST"])
@login_required  # æ·»åŠ è¿™è¡Œ
def agent_chat():
    """æ™ºèƒ½å¯¹è¯æ¥å£"""
    user = get_current_user()  # è·å–å½“å‰ç”¨æˆ·
    
    # åŸæœ‰é€»è¾‘
    data = request.get_json()
    query = data.get("query")
    
    # æ‰§è¡Œåˆ†æï¼ˆåŠ å…¥ç”¨æˆ·æ ‡è¯†ï¼‰
    result = your_analysis_function(query)
    
    # ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ï¼‰
    db.save_analysis(
        user_id=user["open_id"],
        query=query,
        result=result
    )
    
    return jsonify({"code": 0, "data": result})
```

### æ­¥éª¤ 6ï¼šä¿å­˜åˆ†æå†å²

ä¿®æ”¹ä½ çš„åˆ†ææ¥å£ï¼Œæ·»åŠ å†å²è®°å½•ä¿å­˜ï¼š

```python
@app.route("/api/analysis", methods=["POST"])
@login_required
def analyze_data():
    user = get_current_user()
    data = request.get_json()
    
    try:
        # ä½ çš„åˆ†æé€»è¾‘
        result = your_analysis_logic(data)
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        analysis_id = db.save_analysis(
            user_id=user["open_id"],
            query=data.get("query"),
            result=result,
            file_name=data.get("file_name"),
            status="success"
        )
        
        return jsonify({
            "code": 0,
            "data": {
                "analysis_id": analysis_id,
                "result": result
            }
        })
    except Exception as e:
        # ä¿å­˜å¤±è´¥è®°å½•
        db.save_analysis(
            user_id=user["open_id"],
            query=data.get("query"),
            status="error",
            error_message=str(e)
        )
        raise
```

### æ­¥éª¤ 7ï¼šæ·»åŠ å†å²è®°å½•æ¥å£

```python
@app.route("/api/history", methods=["GET"])
@login_required
def get_history():
    """è·å–åˆ†æå†å²"""
    user = get_current_user()
    history = db.get_user_history(user["open_id"])
    
    return jsonify({
        "code": 0,
        "data": {"history": history}
    })

@app.route("/api/history/<int:analysis_id>", methods=["GET"])
@login_required
def restore_analysis(analysis_id):
    """æ¢å¤å†å²åˆ†æ"""
    user = get_current_user()
    detail = db.get_analysis_detail(analysis_id, user["open_id"])
    
    if detail:
        return jsonify({"code": 0, "data": detail})
    return jsonify({"code": -1, "msg": "æ— æƒé™"}), 403
```

---

## æ–¹æ¡ˆäºŒï¼šç‹¬ç«‹éƒ¨ç½²ï¼ˆé€‚åˆå¿«é€Ÿæµ‹è¯•ï¼‰

### æ­¥éª¤ 1ï¼šå¯åŠ¨é£ä¹¦ç™»å½•æœåŠ¡

```bash
cd feishu_web_app
python server_with_persistence.py
# è¿è¡Œåœ¨ http://localhost:3000
```

### æ­¥éª¤ 2ï¼šå¯åŠ¨æ•°æ®åˆ†ææœåŠ¡

```bash
cd backend
python main.py
# è¿è¡Œåœ¨ http://localhost:5000
```

### æ­¥éª¤ 3ï¼šé…ç½®å‰ç«¯ä»£ç†

ä¿®æ”¹ `frontend/vite.config.ts`ï¼š

```javascript
export default defineConfig({
  server: {
    proxy: {
      '/api/login': 'http://localhost:3000',  // ç™»å½•ç›¸å…³
      '/api/check_login': 'http://localhost:3000',
      '/api/current_user': 'http://localhost:3000',
      
      '/api': 'http://localhost:5000',  // å…¶ä»–æ¥å£
    }
  }
})
```

---

## å‰ç«¯é›†æˆ

### æ­¥éª¤ 1ï¼šæ·»åŠ ç™»å½•é€»è¾‘

åœ¨ä½ çš„å‰ç«¯å…¥å£æ–‡ä»¶ï¼ˆå¦‚ `App.jsx`ï¼‰ä¸­æ·»åŠ ï¼š

```javascript
import { useEffect, useState } from 'react';

function App() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    checkLogin();
  }, []);
  
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  const checkLogin = async () => {
    try {
      const res = await fetch('/api/check_login');
      const data = await res.json();
      
      if (data.data.logged_in) {
        setIsLoggedIn(true);
        setUser(data.data.user);
      } else {
        // è‡ªåŠ¨è§¦å‘ç™»å½•
        doLogin();
      }
    } catch (error) {
      console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };
  
  // é£ä¹¦ç™»å½•
  const doLogin = () => {
    if (!window.tt) {
      alert('è¯·åœ¨é£ä¹¦å®¢æˆ·ç«¯ä¸­æ‰“å¼€');
      return;
    }
    
    window.tt.requestAuthCode({
      appId: 'cli_a847b85cdf7dd00c',
      success: (res) => {
        // å‘é€ code åˆ°åç«¯
        fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: res.code })
        })
        .then(response => response.json())
        .then(result => {
          if (result.code === 0) {
            setIsLoggedIn(true);
            setUser(result.data);
          }
        });
      },
      fail: (error) => {
        console.error('ç™»å½•å¤±è´¥:', error);
      }
    });
  };
  
  if (loading) {
    return <div>åŠ è½½ä¸­...</div>;
  }
  
  if (!isLoggedIn) {
    return (
      <div>
        <h1>è¯·ç™»å½•</h1>
        <button onClick={doLogin}>é£ä¹¦ç™»å½•</button>
      </div>
    );
  }
  
  return (
    <div>
      <div>æ¬¢è¿ï¼Œ{user.name}</div>
      {/* ä½ çš„æ•°æ®åˆ†æç•Œé¢ */}
    </div>
  );
}
```

### æ­¥éª¤ 2ï¼šä¿å­˜å’Œæ¢å¤çŠ¶æ€

åœ¨ä½ çš„æ•°æ®åˆ†æç»„ä»¶ä¸­ï¼š

```javascript
import { useEffect } from 'react';

function DataAnalysis() {
  const [analysisResult, setAnalysisResult] = useState(null);
  
  // é¡µé¢åŠ è½½æ—¶æ¢å¤çŠ¶æ€
  useEffect(() => {
    restoreContext();
  }, []);
  
  // æ¢å¤ä¸Šä¸‹æ–‡
  const restoreContext = async () => {
    const res = await fetch('/api/context/restore');
    const data = await res.json();
    
    if (data.code === 0 && data.data.context) {
      // æ¢å¤ä¹‹å‰çš„åˆ†æç»“æœ
      setAnalysisResult(data.data.context.result);
    }
  };
  
  // æ‰§è¡Œåˆ†æ
  const analyze = async (query) => {
    const res = await fetch('/api/analysis/execute', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    
    const data = await res.json();
    if (data.code === 0) {
      setAnalysisResult(data.data.result);
      
      // ä¿å­˜ä¸Šä¸‹æ–‡
      saveContext({ result: data.data.result });
    }
  };
  
  // ä¿å­˜ä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
  const saveContext = async (context) => {
    await fetch('/api/context/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ context })
    });
  };
  
  return (
    <div>
      <input onChange={(e) => analyze(e.target.value)} />
      {analysisResult && <div>{/* å±•ç¤ºç»“æœ */}</div>}
    </div>
  );
}
```

---

## æ•°æ®éš”ç¦»ç¤ºä¾‹

### åœºæ™¯ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ å’Œåˆ†ææ•°æ®

```python
@app.route("/api/upload", methods=["POST"])
@login_required
def upload_file():
    """æ–‡ä»¶ä¸Šä¼ ï¼ˆæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ï¼‰"""
    user = get_current_user()
    
    file = request.files['file']
    
    # æ–‡ä»¶ä¿å­˜åˆ°ç”¨æˆ·ä¸“å±ç›®å½•
    user_dir = f"uploads/{user['open_id']}"
    os.makedirs(user_dir, exist_ok=True)
    
    file_path = os.path.join(user_dir, file.filename)
    file.save(file_path)
    
    # ä¿å­˜åˆ°æ•°æ®åº“
    db.save_file_upload(user["open_id"], {
        "file_name": file.filename,
        "file_path": file_path,
        "file_size": os.path.getsize(file_path)
    })
    
    return jsonify({"code": 0, "msg": "ä¸Šä¼ æˆåŠŸ"})

@app.route("/api/files", methods=["GET"])
@login_required
def list_files():
    """è·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆåªèƒ½çœ‹åˆ°è‡ªå·±çš„ï¼‰"""
    user = get_current_user()
    
    # åªè¿”å›å½“å‰ç”¨æˆ·çš„æ–‡ä»¶
    files = db.get_user_files(user["open_id"])
    
    return jsonify({"code": 0, "data": {"files": files}})
```

---

## å®Œæ•´æµ‹è¯•æµç¨‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨å®Œæ•´ç‰ˆæœåŠ¡å™¨
cd feishu_web_app
python server_with_persistence.py
```

### 2. åœ¨é£ä¹¦ä¸­æ‰“å¼€

è®¿é—®ï¼š`http://127.0.0.1:3000`

### 3. æµ‹è¯•åŠŸèƒ½

#### æµ‹è¯•1ï¼šç”¨æˆ·ç™»å½•
1. ç‚¹å‡»"é£ä¹¦ç™»å½•"
2. è‡ªåŠ¨è·å–ç”¨æˆ·ä¿¡æ¯
3. æ˜¾ç¤ºç”¨æˆ·åå’Œå¤´åƒ

#### æµ‹è¯•2ï¼šæ‰§è¡Œåˆ†æ
```javascript
// å‰ç«¯è°ƒç”¨
fetch('/api/analysis/execute', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: "åˆ†æé”€å”®æ•°æ®",
    file_name: "sales.csv"
  })
})
```

#### æµ‹è¯•3ï¼šåˆ·æ–°é¡µé¢
1. æ‰§è¡Œåˆ†æå
2. æŒ‰ F5 åˆ·æ–°é¡µé¢
3. âœ… ç™»å½•çŠ¶æ€ä¿æŒ
4. âœ… å¯ä»¥æŸ¥çœ‹å†å²è®°å½•

#### æµ‹è¯•4ï¼šå¤šç”¨æˆ·éš”ç¦»
1. ç”¨æˆ·Aç™»å½•ï¼Œä¸Šä¼ æ–‡ä»¶A
2. ç”¨æˆ·Bç™»å½•ï¼Œä¸Šä¼ æ–‡ä»¶B
3. âœ… ç”¨æˆ·Aåªèƒ½çœ‹åˆ°æ–‡ä»¶A
4. âœ… ç”¨æˆ·Båªèƒ½çœ‹åˆ°æ–‡ä»¶B

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä¸ºä¼ä¸šå†…ç”¨æˆ·ï¼Ÿ

**A:** é£ä¹¦çš„ `tt.requestAuthCode()` åªèƒ½åœ¨ä¼ä¸šå®‰è£…çš„åº”ç”¨ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥èƒ½ç™»å½•çš„éƒ½æ˜¯ä¼ä¸šå†…ç”¨æˆ·ã€‚

å¦‚æœéœ€è¦æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼š

```python
@login_required
def some_api():
    user = get_current_user()
    
    # æ£€æŸ¥ç”¨æˆ·æ‰€å±éƒ¨é—¨
    if user.get("department") not in ["ç ”å‘éƒ¨", "äº§å“éƒ¨"]:
        return jsonify({"code": 403, "msg": "æ— æƒé™"}), 403
    
    # ä¸šåŠ¡é€»è¾‘
    ...
```

### Q2: å¦‚ä½•å®ç°"è®°ä½æˆ‘"åŠŸèƒ½ï¼Ÿ

**A:** å·²ç»å®ç°äº†ï¼ŒSession æœ‰æ•ˆæœŸä¸º 24 å°æ—¶ï¼š

```python
app.config['PERMANENT_SESSION_LIFETIME'] = 86400  # 24å°æ—¶
session.permanent = True
```

### Q3: å¦‚ä½•æ¸…ç†è¿‡æœŸæ•°æ®ï¼Ÿ

**A:** å®šæœŸè¿è¡Œæ¸…ç†è„šæœ¬ï¼š

```python
# cleanup.py
from database import db
from datetime import datetime, timedelta

# åˆ é™¤30å¤©å‰çš„åˆ†æè®°å½•
cutoff_date = (datetime.now() - timedelta(days=30)).isoformat()

with db.get_connection() as conn:
    cursor = conn.cursor()
    cursor.execute("""
        DELETE FROM analysis_history
        WHERE created_at < ?
    """, (cutoff_date,))
    
    print(f"æ¸…ç†äº† {cursor.rowcount} æ¡è¿‡æœŸè®°å½•")
```

---

## ä¸‹ä¸€æ­¥

1. âœ… æŒ‰ç…§æœ¬æŒ‡å—é›†æˆåˆ°ä½ çš„é¡¹ç›®
2. âœ… æµ‹è¯•å¤šç”¨æˆ·ç™»å½•å’Œæ•°æ®éš”ç¦»
3. âœ… å®Œå–„ä½ çš„ä¸šåŠ¡é€»è¾‘
4. âœ… å‡†å¤‡ä¸Šçº¿éƒ¨ç½²

**ç°åœ¨ä½ çš„æ•°æ®åˆ†æå·¥å…·å·²ç»æ”¯æŒï¼š**
- âœ… é£ä¹¦ä¼ä¸šç”¨æˆ·ç™»å½•
- âœ… ç”¨æˆ·èº«ä»½è¯†åˆ«
- âœ… åˆ·æ–°ä¸ä¸¢å¤±çŠ¶æ€
- âœ… åˆ†æç»“æœæŒä¹…åŒ–
- âœ… å¤šç”¨æˆ·æ•°æ®éš”ç¦»

ç¥å¼€å‘é¡ºåˆ©ï¼ğŸ‰

